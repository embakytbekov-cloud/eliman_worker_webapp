<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELIMAN WORKER</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: #020613;
            background: radial-gradient(circle at 50% 0%, #0a0e1a 0%, #020613 100%);
            color: #ffffff;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .neon-button {
            background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
            color: #020613;
            font-weight: 700;
            border: none;
            border-radius: 16px;
            padding: 16px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(31, 227, 136, 0.3);
        }
        
        .neon-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(31, 227, 136, 0.5);
        }
        
        .neon-button:active {
            transform: translateY(0);
        }
        
        .neon-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-pill {
            background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
            color: #020613;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pill.offline {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: #ffffff;
        }
        
        .job-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .job-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .tab-button {
            transition: all 0.3s ease;
            border-radius: 12px;
            padding: 12px;
            color: #64748b;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
            color: #020613;
            font-weight: 600;
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .skill-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #1FE388;
            border-radius: 6px;
            background: transparent;
            cursor: pointer;
            position: relative;
        }
        
        .skill-checkbox:checked {
            background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
        }
        
        .skill-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: -2px;
            left: 2px;
            color: #020613;
            font-size: 14px;
            font-weight: bold;
        }
        
        .loading-spinner {
            border: 2px solid rgba(31, 227, 136, 0.3);
            border-top: 2px solid #1FE388;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .rating-stars {
            color: #fbbf24;
        }
        
        .price-tag {
            background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
            color: #020613;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 18px;
        }
        
        .photo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(31, 227, 136, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1FE388;
        }
        
        .bottom-nav {
            background: rgba(2, 6, 19, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            color: #ffffff;
            font-size: 16px;
            width: 100%;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #1FE388;
            box-shadow: 0 0 0 3px rgba(31, 227, 136, 0.1);
        }
        
        .input-field::placeholder {
            color: #64748b;
        }
    </style>
<base target="_blank">
</head>
<body class="min-h-screen pb-20">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex flex-col items-center justify-center p-6">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">ELIMAN WORKER</h1>
            <div class="status-pill offline inline-block mb-6" id="loginStatus">Offline</div>
            <h2 class="text-2xl font-semibold mb-2" id="welcomeTitle">Welcome, worker</h2>
            <p class="text-gray-400 text-sm" id="welcomeSubtitle">Sign in to start accepting jobs in your area</p>
        </div>
        
        <div class="w-full max-w-sm">
            <div class="glass-card p-6 mb-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2" id="phoneLabel">Phone Number</label>
                    <input type="tel" id="phoneInput" class="input-field" placeholder="+1 (312) 555-0147" maxlength="17">
                </div>
                <button id="loginButton" class="neon-button w-full">
                    <span id="loginButtonText">Sign In</span>
                </button>
                <div id="loginError" class="text-red-400 text-sm mt-3 text-center hidden"></div>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="mainScreen" class="hidden min-h-screen">
        <!-- Header -->
        <div class="sticky top-0 z-40 bg-black/50 backdrop-blur-lg border-b border-white/10">
            <div class="flex items-center justify-between p-4">
                <h1 class="text-xl font-bold">ELIMAN WORKER</h1>
                <div class="status-pill" id="onlineStatus">Online</div>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tabContent" class="p-4">
            <!-- Jobs Tab -->
            <div id="jobsTab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1" id="newJobsTitle">New Jobs</h2>
                    <p class="text-gray-400 text-sm" id="newJobsSubtitle">Available jobs matching your skills</p>
                </div>
                <div id="jobsList" class="space-y-4">
                    <!-- Jobs will be loaded here -->
                </div>
                <div id="noJobsText" class="text-center text-gray-400 py-8 hidden">
                    <i class="fas fa-inbox text-4xl mb-4"></i>
                    <p>No jobs available right now</p>
                </div>
            </div>

            <!-- Active Tab -->
            <div id="activeTab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1" id="activeJobsTitle">Active Jobs</h2>
                    <p class="text-gray-400 text-sm" id="activeJobsSubtitle">Jobs you're currently working on</p>
                </div>
                <div id="activeJobsList" class="space-y-4">
                    <!-- Active jobs will be loaded here -->
                </div>
                <div id="noActiveJobsText" class="text-center text-gray-400 py-8 hidden">
                    <i class="fas fa-clock text-4xl mb-4"></i>
                    <p>No active jobs</p>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profileTab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1" id="profileTitle">Profile</h2>
                </div>
                <div class="glass-card p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center text-2xl font-bold mr-4">
                            <span id="profileInitials">JW</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold" id="profileName">John Worker</h3>
                            <p class="text-gray-400 text-sm" id="profileId">ID: •••••••</p>
                        </div>
                    </div>
                    <div class="flex items-center mb-4">
                        <div class="rating-stars text-lg mr-2">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                        </div>
                        <span class="text-sm text-gray-400" id="profileRatingLabel">5.0 rating</span>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-400" id="jobsCompleted">47</div>
                        <div class="text-sm text-gray-400" id="profileJobsLabel">jobs completed</div>
                    </div>
                </div>
                <button id="editSkillsButton" class="neon-button w-full">
                    <span id="editSkillsText">Edit Skills</span>
                </button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="fixed bottom-0 left-0 right-0 bottom-nav z-50">
            <div class="flex justify-around p-2">
                <button class="tab-button active flex flex-col items-center flex-1" data-tab="jobs">
                    <i class="fas fa-briefcase text-xl mb-1"></i>
                    <span class="text-xs" id="jobsTabLabel">Jobs</span>
                </button>
                <button class="tab-button flex flex-col items-center flex-1" data-tab="active">
                    <i class="fas fa-clock text-xl mb-1"></i>
                    <span class="text-xs" id="activeTabLabel">Active</span>
                </button>
                <button class="tab-button flex flex-col items-center flex-1" data-tab="profile">
                    <i class="fas fa-user text-xl mb-1"></i>
                    <span class="text-xs" id="profileTabLabel">Profile</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div id="jobModal" class="fixed inset-0 z-50 hidden modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="glass-card max-w-md w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold" id="modalTitle">Job Details</h3>
                        <button id="closeModal" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="modalContent">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skills Editor Modal -->
    <div id="skillsModal" class="fixed inset-0 z-50 hidden modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="glass-card max-w-md w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold" id="skillsModalTitle">Edit Skills</h3>
                        <button id="closeSkillsModal" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="skillsList" class="space-y-3 mb-6">
                        <!-- Skills will be loaded here -->
                    </div>
                    <div class="flex gap-3">
                        <button id="saveSkills" class="neon-button flex-1">
                            <span id="saveButtonText">Save</span>
                        </button>
                        <button id="cancelSkills" class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-16px font-semibold">
                            <span id="cancelButtonText">Cancel</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Supabase
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // Supabase configuration
        const SUPABASE_URL = 'https://zmjvhedwxdopieuteiky.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzl1NilsInR5cC16IkpXVCJ9.eyJpсЗМiOiJzdХBhYmFzZSIsInJIZil6InptanZoZWR3eGRvcGlldXRlaWt5liwicm9sZS|6ImFub24iLCJpYXQiOjE3NjQ3MTI1MTkslmV4cCI6MjA4MDI4ODUxOX0.1_YyxVTJK2MvDTKmeSjrcgXHNbCr73dEv_1fr1tkeAA';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Telegram WebApp initialization
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.expand();
            tg.disableVerticalSwipes();
        }

        // i18n Dictionary
        const i18n = {
            en: {
                welcome_title: "Welcome, worker",
                welcome_subtitle: "Sign in to start accepting jobs in your area",
                login_button: "Sign In",
                login_error_no_worker: "Worker not found. Please contact support.",
                jobs_tab_label: "Jobs",
                active_tab_label: "Active",
                profile_tab_label: "Profile",
                new_jobs_title: "New Jobs",
                new_jobs_subtitle: "Available jobs matching your skills",
                active_jobs_title: "Active Jobs",
                active_jobs_subtitle: "Jobs you're currently working on",
                profile_title: "Profile",
                profile_rating_label: "rating",
                profile_jobs_completed_label: "jobs completed",
                edit_skills_button: "Edit Skills",
                save_button: "Save",
                cancel_button: "Cancel",
                no_jobs_text: "No jobs available right now",
                no_active_jobs_text: "No active jobs",
                view_details_button: "View Details →",
                accept_job_button: "Accept Job",
                start_job_button: "Start Job",
                complete_job_button: "Complete Job",
                address_label: "Address",
                time_label: "Time",
                client_label: "Client",
                price_label: "Price",
                skills_label: "Skills",
                error_loading_jobs: "Error loading jobs",
                error_updating_job: "Error updating job",
                error_saving_skills: "Error saving skills",
                phoneLabel: "Phone Number",
                editSkillsText: "Edit Skills",
                saveButtonText: "Save",
                cancelButtonText: "Cancel",
                skillsModalTitle: "Edit Skills",
                modalTitle: "Job Details",
                loginButtonText: "Sign In"
            },
            ru: {
                welcome_title: "Добро пожаловать, работник",
                welcome_subtitle: "Войдите, чтобы начать принимать заказы",
                login_button: "Войти",
                login_error_no_worker: "Работник не найден. Обратитесь в поддержку.",
                jobs_tab_label: "Заказы",
                active_tab_label: "Активные",
                profile_tab_label: "Профиль",
                new_jobs_title: "Новые Заказы",
                new_jobs_subtitle: "Доступные заказы по вашим навыкам",
                active_jobs_title: "Активные Заказы",
                active_jobs_subtitle: "Заказы, над которыми вы работаете",
                profile_title: "Профиль",
                profile_rating_label: "рейтинг",
                profile_jobs_completed_label: "завершенных заказов",
                edit_skills_button: "Изменить Навыки",
                save_button: "Сохранить",
                cancel_button: "Отмена",
                no_jobs_text: "Нет доступных заказов",
                no_active_jobs_text: "Нет активных заказов",
                view_details_button: "Подробности →",
                accept_job_button: "Принять Заказ",
                start_job_button: "Начать Работу",
                complete_job_button: "Завершить Работу",
                address_label: "Адрес",
                time_label: "Время",
                client_label: "Клиент",
                price_label: "Цена",
                skills_label: "Навыки",
                error_loading_jobs: "Ошибка загрузки заказов",
                error_updating_job: "Ошибка обновления заказа",
                error_saving_skills: "Ошибка сохранения навыков",
                phoneLabel: "Номер Телефона",
                editSkillsText: "Изменить Навыки",
                saveButtonText: "Сохранить",
                cancelButtonText: "Отмена",
                skillsModalTitle: "Изменить Навыки",
                modalTitle: "Детали Заказа",
                loginButtonText: "Войти"
            },
            es: {
                welcome_title: "Bienvenido, trabajador",
                welcome_subtitle: "Inicia sesión para comenzar a aceptar trabajos",
                login_button: "Iniciar Sesión",
                login_error_no_worker: "Trabajador no encontrado. Contacte soporte.",
                jobs_tab_label: "Trabajos",
                active_tab_label: "Activos",
                profile_tab_label: "Perfil",
                new_jobs_title: "Nuevos Trabajos",
                new_jobs_subtitle: "Trabajos disponibles según tus habilidades",
                active_jobs_title: "Trabajos Activos",
                active_jobs_subtitle: "Trabajos que estás realizando",
                profile_title: "Perfil",
                profile_rating_label: "calificación",
                profile_jobs_completed_label: "trabajos completados",
                edit_skills_button: "Editar Habilidades",
                save_button: "Guardar",
                cancel_button: "Cancelar",
                no_jobs_text: "No hay trabajos disponibles",
                no_active_jobs_text: "No hay trabajos activos",
                view_details_button: "Ver Detalles →",
                accept_job_button: "Aceptar Trabajo",
                start_job_button: "Iniciar Trabajo",
                complete_job_button: "Completar Trabajo",
                address_label: "Dirección",
                time_label: "Hora",
                client_label: "Cliente",
                price_label: "Precio",
                skills_label: "Habilidades",
                error_loading_jobs: "Error al cargar trabajos",
                error_updating_job: "Error al actualizar trabajo",
                error_saving_skills: "Error al guardar habilidades",
                phoneLabel: "Número de Teléfono",
                editSkillsText: "Editar Habilidades",
                saveButtonText: "Guardar",
                cancelButtonText: "Cancelar",
                skillsModalTitle: "Editar Habilidades",
                modalTitle: "Detalles del Trabajo",
                loginButtonText: "Iniciar Sesión"
            },
            ky: {
                welcome_title: "Кош келиңиз, жумушчу",
                welcome_subtitle: "Жумуштарды кабыл алуу үчүн кирүү",
                login_button: "Кирүү",
                login_error_no_worker: "Жумушчу табылган жок. Колдоого кайрылыңыз.",
                jobs_tab_label: "Жумуштар",
                active_tab_label: "Активдүү",
                profile_tab_label: "Профиль",
                new_jobs_title: "Жаңы Жумуштар",
                new_jobs_subtitle: "Сиздин жөндөмдөрүңүзгө ылайык жумуштар",
                active_jobs_title: "Активдүү Жумуштар",
                active_jobs_subtitle: "Учурда аткарып жаткан жумуштарыңыз",
                profile_title: "Профиль",
                profile_rating_label: "рейтинг",
                profile_jobs_completed_label: "аткарылган жумуштар",
                edit_skills_button: "Жөндөмдөрдү Өзгөртүү",
                save_button: "Сактоо",
                cancel_button: "Жокко Чыгаруу",
                no_jobs_text: "Жумуштар жок",
                no_active_jobs_text: "Активдүү жумуштар жок",
                view_details_button: "Толугураак →",
                accept_job_button: "Жумушту Кабыл Алуу",
                start_job_button: "Жумушту Баштоо",
                complete_job_button: "Жумушту Аяктоо",
                address_label: "Дарек",
                time_label: "Убакыт",
                client_label: "Кардар",
                price_label: "Баа",
                skills_label: "Жөндөмдөр",
                error_loading_jobs: "Жумуштарды жүктөөдө ката",
                error_updating_job: "Жумушту жаңыртууда ката",
                error_saving_skills: "Жөндөмдөрдү сактоодо ката",
                phoneLabel: "Телефон Номери",
                editSkillsText: "Жөндөмдөрдү Өзгөртүү",
                saveButtonText: "Сактоо",
                cancelButtonText: "Жокко Чыгаруу",
                skillsModalTitle: "Жөндөмдөрдү Өзгөртүү",
                modalTitle: "Жумуштун Толугураак",
                loginButtonText: "Кирүү"
            }
        };

        // App State
        let currentWorker = null;
        let currentTab = 'jobs';
        let currentLanguage = 'en';
        let jobs = [];
        let activeJobs = [];

        // Skills list
        const availableSkills = [
            'cleaning', 'handyman', 'locksmith', 'moving', 'appliance_repair', 
            'painting', 'plumbing', 'electrical'
        ];

        // Translation function
        function t(key) {
            return i18n[currentLanguage][key] || key;
        }

        // Initialize app
        async function initApp() {
            // Detect language
            if (tg?.initDataUnsafe?.user?.language_code) {
                const lang = tg.initDataUnsafe.user.language_code;
                if (lang === 'ru') currentLanguage = 'ru';
                else if (lang === 'es') currentLanguage = 'es';
                else if (lang === 'ky' || lang === 'kg') currentLanguage = 'ky';
            }

            updateUI();
            
            // Try Telegram auto-login
            if (tg?.initDataUnsafe?.user?.id) {
                await telegramLogin();
            }
        }

        // Telegram login
        async function telegramLogin() {
            const tid = tg.initDataUnsafe.user.id;
            const tname = tg.initDataUnsafe.user.first_name || 'Worker';
            const tlanguage = tg.initDataUnsafe.user.language_code || 'en';

            try {
                // Try to find existing worker
                const { data: existingWorker, error } = await supabase
                    .from('workers')
                    .select('*')
                    .eq('telegram_id', tid.toString())
                    .single();

                if (existingWorker) {
                    currentWorker = existingWorker;
                } else {
                    // Create new worker
                    const { data: newWorker, error: createError } = await supabase
                        .from('workers')
                        .insert({
                            telegram_id: tid.toString(),
                            full_name: tname,
                            skills: '{}',
                            language: tlanguage
                        })
                        .select()
                        .single();

                    if (createError) throw createError;
                    currentWorker = newWorker;
                }

                showMainScreen();
                loadData();
            } catch (error) {
                console.error('Telegram login error:', error);
                showLoginError(t('error_loading_jobs'));
            }
        }

        // Phone login
        async function phoneLogin(phone) {
            try {
                const { data: worker, error } = await supabase
                    .from('workers')
                    .select('*')
                    .eq('phone', phone)
                    .single();

                if (worker) {
                    currentWorker = worker;
                    showMainScreen();
                    loadData();
                } else {
                    showLoginError(t('login_error_no_worker'));
                }
            } catch (error) {
                console.error('Phone login error:', error);
                showLoginError(t('login_error_no_worker'));
            }
        }

        // UI Functions
        function updateUI() {
            // Update all text elements with translations
            document.querySelectorAll('[id]').forEach(element => {
                const key = element.id;
                if (t(key) !== key) {
                    element.textContent = t(key);
                }
            });
        }

        function showLoginError(message) {
            const errorElement = document.getElementById('loginError');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        function showMainScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            updateProfile();
        }

        function updateProfile() {
            if (!currentWorker) return;

            const initials = currentWorker.full_name.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('profileInitials').textContent = initials;
            document.getElementById('profileName').textContent = currentWorker.full_name;
            document.getElementById('profileId').textContent = `ID: ••••${currentWorker.id.slice(-4)}`;
            document.getElementById('jobsCompleted').textContent = currentWorker.jobs_completed;
        }

        // Load data
        async function loadData() {
            await Promise.all([
                loadJobs(),
                loadActiveJobs()
            ]);
        }

        async function loadJobs() {
            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*')
                    .is('worker_id', null)
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Filter by worker skills
                const workerSkills = currentWorker.skills || [];
                jobs = orders.filter(order => 
                    workerSkills.length === 0 || workerSkills.includes(order.service_type)
                );

                renderJobs();
            } catch (error) {
                console.error('Error loading jobs:', error);
                showToast(t('error_loading_jobs'));
            }
        }

        async function loadActiveJobs() {
            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('worker_id', currentWorker.id)
                    .in('status', ['accepted', 'in_progress'])
                    .order('created_at', { ascending: false });

                if (error) throw error;

                activeJobs = orders;
                renderActiveJobs();
            } catch (error) {
                console.error('Error loading active jobs:', error);
                showToast(t('error_loading_jobs'));
            }
        }

        // Render functions
        function renderJobs() {
            const container = document.getElementById('jobsList');
            const noJobsText = document.getElementById('noJobsText');

            if (jobs.length === 0) {
                container.innerHTML = '';
                noJobsText.classList.remove('hidden');
                return;
            }

            noJobsText.classList.add('hidden');
            container.innerHTML = jobs.map(job => `
                <div class="job-card glass-card p-4 fade-in" onclick="showJobDetails('${job.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg mb-1">${job.service_name || job.service_type}</h3>
                            <p class="text-gray-400 text-sm line-clamp-2">${job.notes || 'No additional notes'}</p>
                        </div>
                        <div class="price-tag ml-3">$${job.price}</div>
                    </div>
                    <div class="flex items-center gap-4 mb-3">
                        <div class="flex items-center text-sm text-gray-400">
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            <span class="truncate">${job.address.split(',')[0]}</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-400">
                            <i class="fas fa-clock mr-2"></i>
                            <span>${job.date} ${job.time}</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex -space-x-2">
                            <div class="photo-placeholder">
                                <i class="fas fa-camera text-sm"></i>
                            </div>
                            <div class="photo-placeholder">
                                <i class="fas fa-camera text-sm"></i>
                            </div>
                            <div class="photo-placeholder">
                                <i class="fas fa-camera text-sm"></i>
                            </div>
                            <span class="text-xs text-gray-400 ml-2 self-center">3 photos</span>
                        </div>
                        <button class="text-green-400 font-semibold text-sm">
                            ${t('view_details_button')}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderActiveJobs() {
            const container = document.getElementById('activeJobsList');
            const noActiveJobsText = document.getElementById('noActiveJobsText');

            if (activeJobs.length === 0) {
                container.innerHTML = '';
                noActiveJobsText.classList.remove('hidden');
                return;
            }

            noActiveJobsText.classList.add('hidden');
            container.innerHTML = activeJobs.map(job => `
                <div class="glass-card p-4 fade-in">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-lg">${job.service_name || job.service_type}</h3>
                        <div class="price-tag">$${job.price}</div>
                    </div>
                    <div class="space-y-3 mb-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center text-sm">
                                <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>
                                <span>${job.address.split(',')[0]}</span>
                            </div>
                            <button onclick="openMaps('${job.address}')" class="text-green-400 text-sm">
                                <i class="fas fa-external-link-alt mr-1"></i>Map
                            </button>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center text-sm">
                                <i class="fas fa-user mr-2 text-gray-400"></i>
                                <span>${job.client_name}</span>
                            </div>
                            <button onclick="callPhone('${job.client_phone}')" class="text-green-400 text-sm">
                                <i class="fas fa-phone mr-1"></i>Call
                            </button>
                        </div>
                        <div class="flex items-center text-sm">
                            <i class="fas fa-clock mr-2 text-gray-400"></i>
                            <span>${job.date} ${job.time}</span>
                        </div>
                    </div>
                    <button onclick="updateJobStatus('${job.id}', '${job.status}')" 
                            class="neon-button w-full">
                        ${job.status === 'accepted' ? t('start_job_button') : t('complete_job_button')}
                    </button>
                </div>
            `).join('');
        }

        // Job actions
        function showJobDetails(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            document.getElementById('modalTitle').textContent = job.service_name || job.service_type;
            document.getElementById('modalContent').innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold mb-2">${t('client_label')}</h4>
                        <p class="text-gray-400">${job.client_name}</p>
                        <p class="text-gray-400">${job.client_phone}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">${t('address_label')}</h4>
                        <p class="text-gray-400">${job.address}</p>
                        <button onclick="openMaps('${job.address}')" class="text-green-400 text-sm mt-1">
                            <i class="fas fa-external-link-alt mr-1"></i>Open in Maps
                        </button>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">${t('time_label')}</h4>
                        <p class="text-gray-400">${job.date} at ${job.time}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">${t('price_label')}</h4>
                        <p class="text-2xl font-bold text-green-400">$${job.price}</p>
                    </div>
                    ${job.notes ? `
                    <div>
                        <h4 class="font-semibold mb-2">Notes</h4>
                        <p class="text-gray-400">${job.notes}</p>
                    </div>
                    ` : ''}
                    <button onclick="acceptJob('${job.id}')" class="neon-button w-full mt-6">
                        ${t('accept_job_button')}
                    </button>
                </div>
            `;
            document.getElementById('jobModal').classList.remove('hidden');
        }

        async function acceptJob(jobId) {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner mx-auto"></div>';

            try {
                const { error } = await supabase
                    .from('orders')
                    .update({ 
                        worker_id: currentWorker.id, 
                        status: 'accepted' 
                    })
                    .eq('id', jobId);

                if (error) throw error;

                // Refresh data
                await loadData();
                document.getElementById('jobModal').classList.add('hidden');
                showToast('Job accepted successfully!');
            } catch (error) {
                console.error('Error accepting job:', error);
                showToast(t('error_updating_job'));
            } finally {
                button.disabled = false;
                button.textContent = t('accept_job_button');
            }
        }

        async function updateJobStatus(jobId, currentStatus) {
            const newStatus = currentStatus === 'accepted' ? 'in_progress' : 'completed';
            
            try {
                const { error } = await supabase
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('id', jobId);

                if (error) throw error;

                // If completing job, update worker stats
                if (newStatus === 'completed') {
                    await supabase
                        .from('workers')
                        .update({ jobs_completed: currentWorker.jobs_completed + 1 })
                        .eq('id', currentWorker.id);
                    
                    currentWorker.jobs_completed += 1;
                    updateProfile();
                }

                // Refresh data
                await loadData();
                showToast(newStatus === 'completed' ? 'Job completed!' : 'Job started!');
            } catch (error) {
                console.error('Error updating job status:', error);
                showToast(t('error_updating_job'));
            }
        }

        // Skills management
        function showSkillsEditor() {
            const workerSkills = currentWorker.skills || [];
            const skillsList = document.getElementById('skillsList');
            
            skillsList.innerHTML = availableSkills.map(skill => `
                <label class="flex items-center p-3 glass-card cursor-pointer">
                    <input type="checkbox" class="skill-checkbox mr-3" value="${skill}" 
                           ${workerSkills.includes(skill) ? 'checked' : ''}>
                    <span class="capitalize">${skill.replace('_', ' ')}</span>
                </label>
            `).join('');

            document.getElementById('skillsModal').classList.remove('hidden');
        }

        async function saveSkills() {
            const checkboxes = document.querySelectorAll('#skillsList input:checked');
            const selectedSkills = Array.from(checkboxes).map(cb => cb.value);

            try {
                const { error } = await supabase
                    .from('workers')
                    .update({ skills: selectedSkills })
                    .eq('id', currentWorker.id);

                if (error) throw error;

                currentWorker.skills = selectedSkills;
                document.getElementById('skillsModal').classList.add('hidden');
                await loadData();
                showToast('Skills updated successfully!');
            } catch (error) {
                console.error('Error saving skills:', error);
                showToast(t('error_saving_skills'));
            }
        }

        // Utility functions
        function openMaps(address) {
            const url = `https://www.google.com/maps?q=${encodeURIComponent(address)}`;
            window.open(url, '_blank');
        }

        function callPhone(phone) {
            const cleanPhone = phone.replace(/[^+\d]/g, '');
            window.open(`tel:${cleanPhone}`, '_blank');
        }

        function showToast(message) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');

            currentTab = tabName;
        }

        // Event listeners
        document.getElementById('loginButton').addEventListener('click', async () => {
            const phone = document.getElementById('phoneInput').value;
            if (!phone) return;

            const button = document.getElementById('loginButton');
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner mx-auto"></div>';

            await phoneLogin(phone);

            button.disabled = false;
            button.textContent = t('login_button');
        });

        document.getElementById('phoneInput').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 1) {
                value = '+1 (' + value.substring(1, 4) + ') ' + value.substring(4, 7) + '-' + value.substring(7, 11);
            }
            e.target.value = value;
        });

        document.querySelectorAll('[data-tab]').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        document.getElementById('editSkillsButton').addEventListener('click', showSkillsEditor);
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('jobModal').classList.add('hidden');
        });
        document.getElementById('closeSkillsModal').addEventListener('click', () => {
            document.getElementById('skillsModal').classList.add('hidden');
        });
        document.getElementById('saveSkills').addEventListener('click', saveSkills);
        document.getElementById('cancelSkills').addEventListener('click', () => {
            document.getElementById('skillsModal').classList.add('hidden');
        });

        // Back button handling for Telegram
        if (tg) {
            tg.BackButton.onClick(() => {
                if (!document.getElementById('jobModal').classList.contains('hidden')) {
                    document.getElementById('jobModal').classList.add('hidden');
                } else if (!document.getElementById('skillsModal').classList.contains('hidden')) {
                    document.getElementById('skillsModal').classList.add('hidden');
                }
            });

            // Show/hide back button based on modals
            const observer = new MutationObserver(() => {
                const jobModalVisible = !document.getElementById('jobModal').classList.contains('hidden');
                const skillsModalVisible = !document.getElementById('skillsModal').classList.contains('hidden');
                
                if (jobModalVisible || skillsModalVisible) {
                    tg.BackButton.show();
                } else {
                    tg.BackButton.hide();
                }
            });

            observer.observe(document.getElementById('jobModal'), { attributes: true });
            observer.observe(document.getElementById('skillsModal'), { attributes: true });
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
