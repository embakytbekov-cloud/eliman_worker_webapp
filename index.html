<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ELIMAN WORKER</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <base target="_blank" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

    * {
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: radial-gradient(circle at 50% 0%, #0a0e1a 0%, #020613 100%);
      color: #ffffff;
      overflow-x: hidden;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .neon-button {
      background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
      color: #020613;
      font-weight: 700;
      border: none;
      border-radius: 16px;
      padding: 14px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(31, 227, 136, 0.3);
    }

    .neon-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(31, 227, 136, 0.5);
    }

    .neon-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .secondary-button {
      border-radius: 16px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .status-pill {
      background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
      color: #020613;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-pill.offline {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      color: #ffffff;
    }

    .job-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .job-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }

    .tab-button {
      transition: all 0.3s ease;
      border-radius: 12px;
      padding: 10px;
      color: #64748b;
    }

    .tab-button.active {
      background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
      color: #020613;
      font-weight: 600;
    }

    .modal-overlay {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
    }

    .skill-checkbox {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid #1FE388;
      border-radius: 6px;
      background: transparent;
      cursor: pointer;
      position: relative;
    }

    .skill-checkbox:checked {
      background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
    }

    .skill-checkbox:checked::after {
      content: '‚úì';
      position: absolute;
      top: -2px;
      left: 3px;
      color: #020613;
      font-size: 14px;
      font-weight: bold;
    }

    .loading-spinner {
      border: 2px solid rgba(31, 227, 136, 0.3);
      border-top: 2px solid #1FE388;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .fade-in {
      animation: fadeIn 0.4s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .price-tag {
      background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
      color: #020613;
      padding: 8px 14px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 18px;
    }

    .photo-placeholder {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(31, 227, 136, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1FE388;
    }

    .bottom-nav {
      background: rgba(2, 6, 19, 0.96);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .textarea-bio {
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      padding: 10px 12px;
      font-size: 13px;
      color: #e5e7eb;
      resize: vertical;
      min-height: 70px;
    }

    .textarea-bio::placeholder {
      color: #64748b;
    }

    .textarea-bio:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.5);
    }

    .toggle-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .toggle-label {
      font-size: 14px;
      color: #e5e7eb;
    }

    .toggle {
      width: 46px;
      height: 26px;
      border-radius: 999px;
      background: #1f2937;
      border: 1px solid #4b5563;
      position: relative;
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: #9ca3af;
      transition: all 0.25s ease;
    }

    .toggle.on {
      background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
      border-color: transparent;
    }

    .toggle.on .toggle-thumb {
      transform: translateX(18px);
      background: #020617;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: #e5e7eb;
    }

    .chip-lang {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chip-lang.active {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.15);
      color: #bbf7d0;
    }

    #avatarImg {
      object-fit: cover;
    }
  </style>
</head>
<body class="min-h-screen pb-20">

  <!-- LOGIN SCREEN (Telegram only) -->
  <div id="loginScreen" class="min-h-screen flex flex-col items-center justify-center p-6">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-black mb-2">ELIMAN WORKER</h1>
      <div id="loginStatus" class="status-pill offline inline-block mb-6">Offline</div>
      <h2 id="welcomeTitle" class="text-2xl font-semibold mb-2">Welcome, worker</h2>
      <p id="welcomeSubtitle" class="text-gray-400 text-sm">
        Open this app from Telegram to start accepting jobs
      </p>
    </div>

    <div class="w-full max-w-sm">
      <div class="glass-card p-6 mb-6 text-center">
        <p id="loginHint" class="text-gray-400 text-sm mb-4">
          This mini app works only inside Telegram. Open via bot.
        </p>
        <button id="loginButton" class="neon-button w-full">
          <span id="loginButtonText">Try Telegram Login</span>
        </button>
        <div id="loginError" class="text-red-400 text-sm mt-3 text-center hidden"></div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="mainScreen" class="hidden min-h-screen">

    <!-- HEADER -->
    <div class="sticky top-0 z-40 bg-black/60 backdrop-blur-lg border-b border-white/10">
      <div class="flex items-center justify-between p-4">
        <div>
          <div class="text-xs tracking-[0.25em] text-green-400 uppercase mb-1">Eliman</div>
          <h1 class="text-xl font-bold">Worker Console</h1>
        </div>
        <div id="onlineStatus" class="status-pill">Online</div>
      </div>
    </div>

    <!-- CONTENT -->
    <div id="tabContent" class="p-4 pb-24">

      <!-- JOBS TAB -->
      <div id="jobsTab" class="tab-content">
        <div class="mb-6">
          <h2 id="newJobsTitle" class="text-2xl font-bold mb-1">New Jobs</h2>
          <p id="newJobsSubtitle" class="text-gray-400 text-sm">
            Available jobs matching your skills
          </p>
        </div>
        <div id="jobsList" class="space-y-4"></div>
        <div id="noJobsText" class="text-center text-gray-400 py-8 hidden">
          <i class="fas fa-inbox text-4xl mb-4"></i>
          <p>No jobs available right now</p>
        </div>
      </div>

      <!-- ACTIVE TAB -->
      <div id="activeTab" class="tab-content hidden">
        <div class="mb-6">
          <h2 id="activeJobsTitle" class="text-2xl font-bold mb-1">Active Jobs</h2>
          <p id="activeJobsSubtitle" class="text-gray-400 text-sm">
            Jobs you're currently working on
          </p>
        </div>
        <div id="activeJobsList" class="space-y-4"></div>
        <div id="noActiveJobsText" class="text-center text-gray-400 py-8 hidden">
          <i class="fas fa-clock text-4xl mb-4"></i>
          <p>No active jobs</p>
        </div>
      </div>

      <!-- PROFILE TAB -->
      <div id="profileTab" class="tab-content hidden">
        <div class="mb-6">
          <h2 id="profileTitle" class="text-2xl font-bold mb-1">Profile</h2>
        </div>

        <!-- NEW PROFILE BLOCK -->
        <div class="glass-card p-6 mb-4">
          <!-- –§–æ—Ç–æ + –ò–º—è + ID -->
          <div class="flex items-center mb-4">
            <button id="avatarButton"
                    class="relative w-16 h-16 rounded-full overflow-hidden mr-4 border-2 border-emerald-400 shadow-lg flex items-center justify-center bg-gradient-to-br from-green-400 to-emerald-600">
              <img id="avatarImg" src="" alt="avatar" class="w-full h-full hidden" />
              <span id="profileInitials" class="text-2xl font-bold">WW</span>
              <div class="absolute bottom-[-2px] right-[-2px] bg-black rounded-full p-[3px] border border-emerald-400">
                <i class="fas fa-camera text-[10px] text-emerald-300"></i>
              </div>
            </button>
            <div>
              <h3 id="profileName" class="text-xl font-semibold">Worker</h3>
              <p id="profileId" class="text-gray-400 text-sm">ID: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</p>
            </div>
          </div>

          <!-- –†–µ–π—Ç–∏–Ω–≥ + –ó–∞–∫–∞–∑—ã -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
              <div class="text-yellow-400 text-lg mr-2">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
              </div>
              <span id="profileRatingLabel" class="text-sm text-gray-400">5.0 rating</span>
            </div>
            <div class="text-right">
              <div id="jobsCompleted" class="text-2xl font-bold text-green-400">0</div>
              <div id="profileJobsLabel" class="text-sm text-gray-400">jobs completed</div>
            </div>
          </div>

          <!-- –û —Å–µ–±–µ -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <span id="aboutMeLabel" class="text-sm font-medium text-gray-200">About me</span>
            </div>
            <textarea id="aboutMeInput"
                      class="textarea-bio"
                      placeholder="Handyman with 5+ years experience. Professional and fast."></textarea>
            <div class="flex justify-end mt-2">
              <button id="saveAboutButton" class="secondary-button text-xs">
                <i class="fas fa-save text-[11px]"></i>
                <span id="saveAboutText">Save bio</span>
              </button>
            </div>
          </div>

          <!-- –ù–∞–≤—ã–∫–∏ -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <span id="skillsLabel" class="text-sm font-medium text-gray-200">Skills</span>
            </div>
            <div id="skillsTextList" class="flex flex-wrap gap-2 text-xs text-gray-300">
              <!-- chips -->
            </div>
          </div>

          <!-- Notifications -->
          <div class="mb-1">
            <div class="flex items-center justify-between">
              <div>
                <div id="notificationsLabel" class="text-sm font-medium text-gray-200">Notifications</div>
                <div id="notificationsStatusText" class="text-xs text-gray-400">
                  Receive new job alerts
                </div>
              </div>
              <button id="notificationsToggle" class="toggle">
                <div class="toggle-thumb"></div>
              </button>
            </div>
          </div>
        </div>

        <!-- –ö–ù–û–ü–ö–ò: –Ω–∞–≤—ã–∫–∏ / —Ñ–æ—Ç–æ / —è–∑—ã–∫ -->
        <div class="space-y-3">
          <button id="editSkillsButton" class="neon-button w-full">
            <span id="editSkillsText">Edit Skills</span>
          </button>

          <button id="changePhotoButton" class="secondary-button w-full justify-center">
            <i class="fas fa-image"></i>
            <span id="changePhotoText">Change profile photo</span>
          </button>

          <div class="glass-card p-4">
            <div class="flex items-center justify-between mb-3">
              <span id="languageLabel" class="text-sm font-medium text-gray-200">Language</span>
            </div>
            <div class="flex flex-wrap gap-2">
              <button class="chip chip-lang" data-lang="en">English</button>
              <button class="chip chip-lang" data-lang="ru">–†—É—Å—Å–∫–∏–π</button>
              <button class="chip chip-lang" data-lang="es">Espa√±ol</button>
              <button class="chip chip-lang" data-lang="ky">–ö—ã—Ä–≥—ã–∑—á–∞</button>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- BOTTOM NAV -->
    <div class="fixed bottom-0 left-0 right-0 bottom-nav z-50">
      <div class="flex justify-around p-2">
        <button class="tab-button active flex flex-col items-center flex-1" data-tab="jobs">
          <i class="fas fa-briefcase text-xl mb-1"></i>
          <span id="jobsTabLabel" class="text-xs">Jobs</span>
        </button>
        <button class="tab-button flex flex-col items-center flex-1" data-tab="active">
          <i class="fas fa-clock text-xl mb-1"></i>
          <span id="activeTabLabel" class="text-xs">Active</span>
        </button>
        <button class="tab-button flex flex-col items-center flex-1" data-tab="profile">
          <i class="fas fa-user text-xl mb-1"></i>
          <span id="profileTabLabel" class="text-xs">Profile</span>
        </button>
      </div>
    </div>
  </div>

  <!-- JOB DETAILS MODAL -->
  <div id="jobModal" class="fixed inset-0 z-50 hidden modal-overlay">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="glass-card max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-start mb-4">
            <h3 id="modalTitle" class="text-xl font-bold">Job Details</h3>
            <button id="closeModal" class="text-gray-400 hover:text-white">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div id="modalContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SKILLS EDITOR MODAL -->
  <div id="skillsModal" class="fixed inset-0 z-50 hidden modal-overlay">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="glass-card max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-start mb-4">
            <h3 id="skillsModalTitle" class="text-xl font-bold">Edit Skills</h3>
            <button id="closeSkillsModal" class="text-gray-400 hover:text-white">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div id="skillsList" class="space-y-3 mb-6"></div>
          <div class="flex gap-3">
            <button id="saveSkills" class="neon-button flex-1">
              <span id="saveButtonText">Save</span>
            </button>
            <button id="cancelSkills"
              class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-2xl font-semibold text-sm">
              <span id="cancelButtonText">Cancel</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- HIDDEN INPUT FOR AVATAR -->
  <input id="avatarFileInput" type="file" accept="image/*" class="hidden" />

  <!-- APP LOGIC -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://zmjvhedwxdopieuteiky.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptanZoZWR3eGRvcGlldXRlaWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MTI1MTksImV4cCI6MjA4MDI4ODUxOX0.1_YyxVTJK2MvDTKmeSjrcgXHNbCr73dEv_1fr1tkeAA";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.disableVerticalSwipes();
    }

    // üåç i18n
    const i18n = {
      en: {
        welcomeTitle: "Welcome, worker",
        welcomeSubtitle: "Sign in to start accepting jobs in your area",
        loginButton: "Try Telegram Login",
        loginHint: "This mini app works only inside Telegram. Open via bot.",
        loginErrorNoWorker: "Worker not found. Please contact support.",
        jobsTabLabel: "Jobs",
        activeTabLabel: "Active",
        profileTabLabel: "Profile",
        newJobsTitle: "New Jobs",
        newJobsSubtitle: "Available jobs matching your skills",
        activeJobsTitle: "Active Jobs",
        activeJobsSubtitle: "Jobs you're currently working on",
        profileTitle: "Profile",
        profileRatingLabel: "rating",
        profileJobsLabel: "jobs completed",
        aboutMeLabel: "About me",
        aboutPlaceholder: "Handyman with 5+ years experience. Professional and fast.",
        saveAboutText: "Save bio",
        skillsLabel: "Skills",
        notificationsLabel: "Notifications",
        notificationsOn: "Receive new job alerts",
        notificationsOff: "Notifications are off",
        changePhotoText: "Change profile photo",
        languageLabel: "Language",
        noJobsText: "No jobs available right now",
        noActiveJobsText: "No active jobs",
        viewDetailsButton: "View Details ‚Üí",
        acceptJobButton: "Accept Job",
        startJobButton: "Start Job",
        completeJobButton: "Complete Job",
        addressLabel: "Address",
        timeLabel: "Time",
        clientLabel: "Client",
        priceLabel: "Price",
        notesLabel: "Notes",
        errorLoadingJobs: "Error loading jobs",
        errorUpdatingJob: "Error updating job",
        errorSavingSkills: "Error saving skills",
        jobAcceptedToast: "Job accepted!",
        jobStartedToast: "Job started!",
        jobCompletedToast: "Job completed!",
        skillsUpdatedToast: "Skills updated!",
        bioSavedToast: "Bio saved!",
        avatarUpdatedToast: "Profile photo updated!",
        notifOnToast: "Notifications enabled",
        notifOffToast: "Notifications disabled",
        avatarErrorToast: "Error uploading photo",
        languageChangedToast: "Language changed",
      },
      ru: {
        welcomeTitle: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, —Ä–∞–±–æ—Ç–Ω–∏–∫",
        welcomeSubtitle: "–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–∫–∞–∑—ã —Ä—è–¥–æ–º —Å –≤–∞–º–∏",
        loginButton: "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram",
        loginHint: "–≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.",
        loginErrorNoWorker: "–†–∞–±–æ—Ç–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.",
        jobsTabLabel: "–ó–∞–∫–∞–∑—ã",
        activeTabLabel: "–ê–∫—Ç–∏–≤–Ω—ã–µ",
        profileTabLabel: "–ü—Ä–æ—Ñ–∏–ª—å",
        newJobsTitle: "–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã",
        newJobsSubtitle: "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã –ø–æ –≤–∞—à–∏–º –Ω–∞–≤—ã–∫–∞–º",
        activeJobsTitle: "–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã",
        activeJobsSubtitle: "–ó–∞–∫–∞–∑—ã, –Ω–∞–¥ –∫–æ—Ç–æ—Ä—ã–º–∏ –≤—ã —Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç–µ",
        profileTitle: "–ü—Ä–æ—Ñ–∏–ª—å",
        profileRatingLabel: "—Ä–µ–π—Ç–∏–Ω–≥",
        profileJobsLabel: "–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤",
        aboutMeLabel: "–û —Å–µ–±–µ",
        aboutPlaceholder: "Handyman —Å 5+ –≥–æ–¥–∞–º–∏ –æ–ø—ã—Ç–∞. –ë—ã—Å—Ç—Ä–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ.",
        saveAboutText: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ",
        skillsLabel: "–ù–∞–≤—ã–∫–∏",
        notificationsLabel: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
        notificationsOn: "–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö",
        notificationsOff: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã",
        changePhotoText: "–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è",
        languageLabel: "–Ø–∑—ã–∫",
        noJobsText: "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤",
        noActiveJobsText: "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤",
        viewDetailsButton: "–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí",
        acceptJobButton: "–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑",
        startJobButton: "–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É",
        completeJobButton: "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É",
        addressLabel: "–ê–¥—Ä–µ—Å",
        timeLabel: "–í—Ä–µ–º—è",
        clientLabel: "–ö–ª–∏–µ–Ω—Ç",
        priceLabel: "–¶–µ–Ω–∞",
        notesLabel: "–ó–∞–º–µ—Ç–∫–∏",
        errorLoadingJobs: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤",
        errorUpdatingJob: "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞",
        errorSavingSkills: "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤",
        jobAcceptedToast: "–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!",
        jobStartedToast: "–†–∞–±–æ—Ç–∞ –Ω–∞—á–∞—Ç–∞!",
        jobCompletedToast: "–†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!",
        skillsUpdatedToast: "–ù–∞–≤—ã–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!",
        bioSavedToast: "–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!",
        avatarUpdatedToast: "–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ!",
        notifOnToast: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã",
        notifOffToast: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã",
        avatarErrorToast: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ",
        languageChangedToast: "–Ø–∑—ã–∫ –∏–∑–º–µ–Ω—ë–Ω",
      },
      es: {
        welcomeTitle: "Bienvenido, trabajador",
        welcomeSubtitle: "Inicia sesi√≥n para aceptar trabajos en tu √°rea",
        loginButton: "Iniciar con Telegram",
        loginHint: "Esta mini app solo funciona dentro de Telegram. √Åbrela desde el bot.",
        loginErrorNoWorker: "Trabajador no encontrado. Contacta soporte.",
        jobsTabLabel: "Trabajos",
        activeTabLabel: "Activos",
        profileTabLabel: "Perfil",
        newJobsTitle: "Nuevos trabajos",
        newJobsSubtitle: "Trabajos disponibles seg√∫n tus habilidades",
        activeJobsTitle: "Trabajos activos",
        activeJobsSubtitle: "Trabajos que est√°s realizando",
        profileTitle: "Perfil",
        profileRatingLabel: "calificaci√≥n",
        profileJobsLabel: "trabajos completados",
        aboutMeLabel: "Sobre m√≠",
        aboutPlaceholder: "Handyman con m√°s de 5 a√±os de experiencia. R√°pido y profesional.",
        saveAboutText: "Guardar descripci√≥n",
        skillsLabel: "Habilidades",
        notificationsLabel: "Notificaciones",
        notificationsOn: "Recibir avisos de nuevos trabajos",
        notificationsOff: "Notificaciones desactivadas",
        changePhotoText: "Cambiar foto de perfil",
        languageLabel: "Idioma",
        noJobsText: "No hay trabajos disponibles",
        noActiveJobsText: "No hay trabajos activos",
        viewDetailsButton: "Ver detalles ‚Üí",
        acceptJobButton: "Aceptar trabajo",
        startJobButton: "Empezar trabajo",
        completeJobButton: "Completar trabajo",
        addressLabel: "Direcci√≥n",
        timeLabel: "Hora",
        clientLabel: "Cliente",
        priceLabel: "Precio",
        notesLabel: "Notas",
        errorLoadingJobs: "Error al cargar trabajos",
        errorUpdatingJob: "Error al actualizar trabajo",
        errorSavingSkills: "Error al guardar habilidades",
        jobAcceptedToast: "¬°Trabajo aceptado!",
        jobStartedToast: "¬°Trabajo iniciado!",
        jobCompletedToast: "¬°Trabajo completado!",
        skillsUpdatedToast: "¬°Habilidades actualizadas!",
        bioSavedToast: "¬°Descripci√≥n guardada!",
        avatarUpdatedToast: "¬°Foto de perfil actualizada!",
        notifOnToast: "Notificaciones activadas",
        notifOffToast: "Notificaciones desactivadas",
        avatarErrorToast: "Error al subir foto",
        languageChangedToast: "Idioma cambiado",
      },
      ky: {
        welcomeTitle: "–ö–æ—à –∫–µ–ª–∏“£–∏–∑, –∂—É–º—É—à—á—É",
        welcomeSubtitle: "–ê–π–ª–∞–Ω–∞“£—ã–∑–¥–∞–≥—ã –∂—É–º—É—à—Ç–∞—Ä–¥—ã –∫–∞–±—ã–ª –∞–ª—É—É “Ø—á“Ø–Ω –∫–∏—Ä–∏“£–∏–∑",
        loginButton: "Telegram –∞—Ä–∫—ã–ª—É—É –∫–∏—Ä“Ø“Ø",
        loginHint: "–ë—É–ª –º–∏–Ω–∏-—Ç–∏—Ä–∫–µ–º–µ Telegram –∏—á–∏–Ω–¥–µ –≥–∞–Ω–∞ –∏—à—Ç–µ–π—Ç. –ë–æ—Ç –∞—Ä–∫—ã–ª—É—É –∞—á—ã“£—ã–∑.",
        loginErrorNoWorker: "–ñ—É–º—É—à—á—É —Ç–∞–±—ã–ª–≥–∞–Ω –∂–æ–∫. –ö–æ–ª–¥–æ–æ –∫—ã–∑–º–∞—Ç—ã–Ω–∞ –∫–∞–π—Ä—ã–ª—ã“£—ã–∑.",
        jobsTabLabel: "–ñ—É–º—É—à—Ç–∞—Ä",
        activeTabLabel: "–ê–∫—Ç–∏–≤–¥“Ø“Ø",
        profileTabLabel: "–ü—Ä–æ—Ñ–∏–ª—å",
        newJobsTitle: "–ñ–∞“£—ã –∂—É–º—É—à—Ç–∞—Ä",
        newJobsSubtitle: "–°–∏–∑–¥–∏–Ω –∂”©–Ω–¥”©–º–¥”©—Ä“Ø“£“Ø–∑–≥”© –∂–∞—Ä–∞—à–∞ –∂—É–º—É—à—Ç–∞—Ä",
        activeJobsTitle: "–ê–∫—Ç–∏–≤–¥“Ø“Ø –∂—É–º—É—à—Ç–∞—Ä",
        activeJobsSubtitle: "–ê–∑—ã—Ä –∞—Ç–∫–∞—Ä—ã–ø –∂–∞—Ç–∫–∞–Ω –∂—É–º—É—à—Ç–∞—Ä—ã“£—ã–∑",
        profileTitle: "–ü—Ä–æ—Ñ–∏–ª—å",
        profileRatingLabel: "—Ä–µ–π—Ç–∏–Ω–≥",
        profileJobsLabel: "–∞—è–∫—Ç–∞–≥–∞–Ω –∂—É–º—É—à—Ç–∞—Ä",
        aboutMeLabel: "”®–∑“Ø–º –∂”©–Ω“Ø–Ω–¥”©",
        aboutPlaceholder: "5+ –∂—ã–ª–¥—ã–∫ —Ç–∞–∂—Ä—ã–π–±–∞–ª—É—É handyman. –´–∫—á–∞–º –∂–∞–Ω–∞ –∫–µ—Å–∏–ø–∫”©–π.",
        saveAboutText: "–°“Ø—Ä”©—Ç—Ç”©–º”©–Ω“Ø —Å–∞–∫—Ç–æ–æ",
        skillsLabel: "–ñ”©–Ω–¥”©–º–¥”©—Ä",
        notificationsLabel: "–ë–∏–ª–¥–∏—Ä–º–µ–ª–µ—Ä",
        notificationsOn: "–ñ–∞“£—ã –∂—É–º—É—à—Ç–∞—Ä –±–æ—é–Ω—á–∞ –±–∏–ª–¥–∏—Ä–º–µ –∞–ª—É—É",
        notificationsOff: "–ë–∏–ª–¥–∏—Ä–º–µ–ª–µ—Ä ”©—á“Ø—Ä“Ø–ª–≥”©–Ω",
        changePhotoText: "–ü—Ä–æ—Ñ–∏–ª—å —Å“Ø—Ä”©—Ç“Ø–Ω –∞–ª–º–∞—à—Ç—ã—Ä—É—É",
        languageLabel: "–¢–∏–ª",
        noJobsText: "–ê–∑—ã—Ä—ã–Ω—á–∞ –∂—É–º—É—à—Ç–∞—Ä –∂–æ–∫",
        noActiveJobsText: "–ê–∫—Ç–∏–≤–¥“Ø“Ø –∂—É–º—É—à—Ç–∞—Ä –∂–æ–∫",
        viewDetailsButton: "–ö–µ–Ω–µ–Ω–∏—Ä—ç—ç–∫ ‚Üí",
        acceptJobButton: "–ñ—É–º—É—à—Ç—É –∫–∞–±—ã–ª –∞–ª—É—É",
        startJobButton: "–ñ—É–º—É—à—Ç—É –±–∞—à—Ç–æ–æ",
        completeJobButton: "–ñ—É–º—É—à—Ç—É –±“Ø—Ç“Ø—Ä“Ø“Ø",
        addressLabel: "–î–∞—Ä–µ–∫",
        timeLabel: "–£–±–∞–∫—ã—Ç",
        clientLabel: "–ö–∞—Ä–¥–∞—Ä",
        priceLabel: "–ë–∞–∞",
        notesLabel: "–≠—Å–∫–µ—Ä—Ç–º–µ–ª–µ—Ä",
        errorLoadingJobs: "–ñ—É–º—É—à—Ç–∞—Ä–¥—ã –∂“Ø–∫—Ç”©”©–¥”© –∫–∞—Ç–∞",
        errorUpdatingJob: "–ñ—É–º—É—à—Ç—É –∂–∞“£—ã—Ä—Ç—É—É–¥–∞ –∫–∞—Ç–∞",
        errorSavingSkills: "–ñ”©–Ω–¥”©–º–¥”©—Ä–¥“Ø —Å–∞–∫—Ç–æ–æ–¥–æ –∫–∞—Ç–∞",
        jobAcceptedToast: "–ñ—É–º—É—à –∫–∞–±—ã–ª –∞–ª—ã–Ω–¥—ã!",
        jobStartedToast: "–ñ—É–º—É—à –±–∞—à—Ç–∞–ª–¥—ã!",
        jobCompletedToast: "–ñ—É–º—É—à –∞—è–∫—Ç–∞–¥—ã!",
        skillsUpdatedToast: "–ñ”©–Ω–¥”©–º–¥”©—Ä –∂–∞“£—ã—Ä—Ç—ã–ª–¥—ã!",
        bioSavedToast: "–°“Ø—Ä”©—Ç—Ç”©–º”© —Å–∞–∫—Ç–∞–ª–¥—ã!",
        avatarUpdatedToast: "–ü—Ä–æ—Ñ–∏–ª—å —Å“Ø—Ä”©—Ç“Ø –∂–∞“£—ã—Ä–¥—ã!",
        notifOnToast: "–ë–∏–ª–¥–∏—Ä–º–µ–ª–µ—Ä –∫“Ø–π–≥“Ø–∑“Ø–ª–¥“Ø",
        notifOffToast: "–ë–∏–ª–¥–∏—Ä–º–µ–ª–µ—Ä ”©—á“Ø—Ä“Ø–ª–¥“Ø",
        avatarErrorToast: "–°“Ø—Ä”©—Ç –∂“Ø–∫—Ç”©”©–¥”© –∫–∞—Ç–∞",
        languageChangedToast: "–¢–∏–ª ”©–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø",
      },
    };

    let currentLanguage = "en";
    let currentWorker = null;
    let jobs = [];
    let activeJobs = [];

    const availableSkills = [
      "cleaning",
      "handyman",
      "locksmith",
      "moving",
      "appliance_repair",
      "painting",
      "plumbing",
      "electrical",
    ];

    const $ = (id) => document.getElementById(id);
    const t = (key) => i18n[currentLanguage][key] || key;

    function showToast(message) {
      const toast = document.createElement("div");
      toast.className =
        "fixed top-4 left-1/2 -translate-x-1/2 bg-emerald-500 text-white px-6 py-3 rounded-lg z-[9999] shadow-lg text-sm";
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    function updateTexts() {
      $("welcomeTitle").textContent = t("welcomeTitle");
      $("welcomeSubtitle").textContent = t("welcomeSubtitle");
      $("loginButtonText").textContent = t("loginButton");
      $("loginHint").textContent = t("loginHint");

      $("newJobsTitle").textContent = t("newJobsTitle");
      $("newJobsSubtitle").textContent = t("newJobsSubtitle");
      $("activeJobsTitle").textContent = t("activeJobsTitle");
      $("activeJobsSubtitle").textContent = t("activeJobsSubtitle");
      $("profileTitle").textContent = t("profileTitle");
      $("profileRatingLabel").textContent = "5.0 " + t("profileRatingLabel");
      $("profileJobsLabel").textContent = t("profileJobsLabel");

      $("aboutMeLabel").textContent = t("aboutMeLabel");
      $("aboutMeInput").placeholder = t("aboutPlaceholder");
      $("saveAboutText").textContent = t("saveAboutText");
      $("skillsLabel").textContent = t("skillsLabel");
      $("notificationsLabel").textContent = t("notificationsLabel");
      $("changePhotoText").textContent = t("changePhotoText");
      $("languageLabel").textContent = t("languageLabel");

      $("skillsModalTitle").textContent = t("skillsLabel");
      $("editSkillsText").textContent = t("editSkillsButton") || "Edit Skills";
      $("saveButtonText").textContent = t("saveButton");
      $("cancelButtonText").textContent = t("cancelButton");
      $("modalTitle").textContent = t("modalTitle") || "Job Details";

      $("jobsTabLabel").textContent = t("jobsTabLabel");
      $("activeTabLabel").textContent = t("activeTabLabel");
      $("profileTabLabel").textContent = t("profileTabLabel");

      $("noJobsText").querySelector("p").textContent = t("noJobsText");
      $("noActiveJobsText").querySelector("p").textContent = t("noActiveJobsText");

      updateNotificationText();
      updateLangChips();
    }

    function showLoginError(msg) {
      const el = $("loginError");
      el.textContent = msg;
      el.classList.remove("hidden");
    }

    function showMainScreen() {
      $("loginScreen").classList.add("hidden");
      $("mainScreen").classList.remove("hidden");
      $("loginStatus").classList.remove("offline");
      $("loginStatus").textContent = "Telegram";
      $("onlineStatus").textContent = "Online";
      updateProfileUI();
    }

    function updateProfileUI() {
      if (!currentWorker) return;
      const name = currentWorker.full_name || "Worker";
      const initials = name
        .split(" ")
        .filter(Boolean)
        .map((n) => n[0])
        .join("")
        .slice(0, 2)
        .toUpperCase();

      const idStr = String(currentWorker.id || "");
      $("profileName").textContent = name;
      $("profileId").textContent = "ID: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢" + idStr.slice(-4);
      $("jobsCompleted").textContent = currentWorker.jobs_completed || 0;

      const avatarUrl = currentWorker.avatar_url;
      const avatarImg = $("avatarImg");
      const initialsEl = $("profileInitials");
      if (avatarUrl) {
        avatarImg.src = avatarUrl;
        avatarImg.classList.remove("hidden");
        initialsEl.classList.add("hidden");
      } else {
        avatarImg.classList.add("hidden");
        initialsEl.classList.remove("hidden");
        initialsEl.textContent = initials || "W";
      }

      $("aboutMeInput").value = currentWorker.about_me || "";

      const skillsContainer = $("skillsTextList");
      skillsContainer.innerHTML = "";
      const workerSkills = currentWorker.skills || [];
      if (!workerSkills.length) {
        const span = document.createElement("span");
        span.className = "text-xs text-gray-500";
        span.textContent = "No skills selected";
        skillsContainer.appendChild(span);
      } else {
        workerSkills.forEach((s) => {
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.textContent = s.replace("_", " ");
          skillsContainer.appendChild(chip);
        });
      }

      const notifEnabled =
        currentWorker.notifications_enabled === null ||
        currentWorker.notifications_enabled === undefined
          ? true
          : currentWorker.notifications_enabled;

      const toggle = $("notificationsToggle");
      if (notifEnabled) toggle.classList.add("on");
      else toggle.classList.remove("on");

      updateNotificationText();
      updateLangChips();
    }

    function updateNotificationText() {
      if (!currentWorker) return;
      const notifEnabled =
        currentWorker.notifications_enabled === null ||
        currentWorker.notifications_enabled === undefined
          ? true
          : currentWorker.notifications_enabled;
      $("notificationsStatusText").textContent = notifEnabled
        ? t("notificationsOn")
        : t("notificationsOff");
    }

    function updateLangChips() {
      document.querySelectorAll(".chip-lang").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.lang === currentLanguage);
      });
    }

    async function telegramLogin() {
      if (!tg || !tg.initDataUnsafe?.user) {
        showLoginError("Open this app from Telegram bot.");
        return;
      }

      const u = tg.initDataUnsafe.user;
      const telegram_id = String(u.id);
      const full_name = [u.first_name, u.last_name].filter(Boolean).join(" ") || "Worker";
      const lang_code = u.language_code || "en";

      if (lang_code === "ru") currentLanguage = "ru";
      else if (lang_code === "es") currentLanguage = "es";
      else if (lang_code === "ky" || lang_code === "kg") currentLanguage = "ky";
      else currentLanguage = "en";
      updateTexts();

      try {
        let { data: worker, error } = await supabase
          .from("workers")
          .select("*")
          .eq("telegram_id", telegram_id)
          .single();

        if (error && error.code !== "PGRST116") throw error;

        if (!worker) {
          const { data: newWorker, error: insertErr } = await supabase
            .from("workers")
            .insert({
              telegram_id,
              full_name,
              language: currentLanguage,
              skills: [],
              notifications_enabled: true,
            })
            .select()
            .single();

          if (insertErr) throw insertErr;
          worker = newWorker;
        }

        currentWorker = worker;
        showMainScreen();
        await loadAllData();
      } catch (e) {
        console.error("Telegram login error:", e);
        showLoginError(t("loginErrorNoWorker"));
      }
    }

    async function loadAllData() {
      await Promise.all([loadJobs(), loadActiveJobs()]);
    }

    async function loadJobs() {
      if (!currentWorker) return;
      try {
        const { data: orders, error } = await supabase
          .from("orders")
          .select("*")
          .is("worker_id", null)
          .eq("status", "pending")
          .order("created_at", { ascending: false });

        if (error) throw error;

        const workerSkills = currentWorker.skills || [];
        jobs = orders.filter(
          (o) => workerSkills.length === 0 || workerSkills.includes(o.service_type)
        );

        renderJobs();
      } catch (e) {
        console.error("loadJobs error:", e);
        showToast(t("errorLoadingJobs"));
      }
    }

    async function loadActiveJobs() {
      if (!currentWorker) return;
      try {
        const { data: orders, error } = await supabase
          .from("orders")
          .select("*")
          .eq("worker_id", currentWorker.id)
          .in("status", ["accepted", "in_progress"])
          .order("created_at", { ascending: false });

        if (error) throw error;

        activeJobs = orders;
        renderActiveJobs();
      } catch (e) {
        console.error("loadActiveJobs error:", e);
        showToast(t("errorLoadingJobs"));
      }
    }

    function renderJobs() {
      const list = $("jobsList");
      const empty = $("noJobsText");

      if (!jobs.length) {
        list.innerHTML = "";
        empty.classList.remove("hidden");
        return;
      }

      empty.classList.add("hidden");
      list.innerHTML = "";
      jobs.forEach((job) => {
        const card = document.createElement("div");
        card.className = "job-card glass-card p-4 fade-in";
        const serviceName = job.service_name || job.service_type;
        const notes = job.notes || "No additional notes";
        const shortAddress = (job.address || "").split(",")[0] || job.address || "";
        const when = [job.date, job.time].filter(Boolean).join(" ");

        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
              <h3 class="font-semibold text-lg mb-1">${serviceName}</h3>
              <p class="text-gray-400 text-sm line-clamp-2">${notes}</p>
            </div>
            <div class="price-tag ml-3">${job.price ? `$${job.price}` : "$‚Äî"}</div>
          </div>
          <div class="flex items-center gap-4 mb-3">
            <div class="flex items-center text-sm text-gray-300">
              <i class="fas fa-map-marker-alt mr-2"></i>
              <span class="truncate">${shortAddress}</span>
            </div>
            <div class="flex items-center text-sm text-gray-300">
              <i class="fas fa-clock mr-2"></i>
              <span>${when}</span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex -space-x-2">
              <div class="photo-placeholder">
                <i class="fas fa-camera text-xs"></i>
              </div>
              <div class="photo-placeholder">
                <i class="fas fa-camera text-xs"></i>
              </div>
              <div class="photo-placeholder">
                <i class="fas fa-camera text-xs"></i>
              </div>
              <span class="text-xs text-gray-400 ml-2 self-center">3 photos</span>
            </div>
            <button class="text-green-400 font-semibold text-sm view-details-btn">
              ${t("viewDetailsButton")}
            </button>
          </div>
        `;

        card.querySelector(".view-details-btn").addEventListener("click", (e) => {
          e.stopPropagation();
          showJobDetails(job);
        });

        list.appendChild(card);
      });
    }

    function renderActiveJobs() {
      const list = $("activeJobsList");
      const empty = $("noActiveJobsText");

      if (!activeJobs.length) {
        list.innerHTML = "";
        empty.classList.remove("hidden");
        return;
      }

      empty.classList.add("hidden");
      list.innerHTML = "";

      activeJobs.forEach((job) => {
        const card = document.createElement("div");
        card.className = "glass-card p-4 fade-in";
        const serviceName = job.service_name || job.service_type;
        const shortAddress = (job.address || "").split(",")[0] || job.address || "";
        const when = [job.date, job.time].filter(Boolean).join(" ";

        const buttonLabel =
          job.status === "accepted" ? t("startJobButton") : t("completeJobButton");

        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <h3 class="font-semibold text-lg">${serviceName}</h3>
            <div class="price-tag">${job.price ? `$${job.price}` : "$‚Äî"}</div>
          </div>
          <div class="space-y-3 mb-4">
            <div class="flex items-center justify-between text-sm">
              <div class="flex items-center text-gray-200">
                <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>
                <span>${shortAddress}</span>
              </div>
              <button class="text-green-400 text-xs underline open-map-btn">
                <i class="fas fa-external-link-alt mr-1"></i>Map
              </button>
            </div>
            <div class="flex items-center justify-between text-sm">
              <div class="flex items-center text-gray-200">
                <i class="fas fa-user mr-2 text-gray-400"></i>
                <span>${job.client_name || ""}</span>
              </div>
              <button class="text-green-400 text-xs underline call-btn">
                <i class="fas fa-phone mr-1"></i>Call
              </button>
            </div>
            <div class="flex items-center text-sm text-gray-200">
              <i class="fas fa-clock mr-2 text-gray-400"></i>
              <span>${when}</span>
            </div>
          </div>
          <button class="neon-button w-full status-btn">
            ${buttonLabel}
          </button>
        `;

        card.querySelector(".open-map-btn").addEventListener("click", () => {
          openMaps(job.address);
        });
        card.querySelector(".call-btn").addEventListener("click", () => {
          callPhone(job.client_phone);
        });
        card.querySelector(".status-btn").addEventListener("click", () => {
          updateJobStatus(job);
        });

        list.appendChild(card);
      });
    }

    function showJobDetails(job) {
      $("modalTitle").textContent = job.service_name || job.service_type;
      const when = [job.date, job.time].filter(Boolean).join(" ");
      const notes = job.notes || "";

      $("modalContent").innerHTML = `
        <div class="space-y-4 text-sm">
          <div>
            <h4 class="font-semibold mb-1">${t("clientLabel")}</h4>
            <p class="text-gray-300">${job.client_name || ""}</p>
            <p class="text-gray-400">${job.client_phone || ""}</p>
          </div>
          <div>
            <h4 class="font-semibold mb-1">${t("addressLabel")}</h4>
            <p class="text-gray-300">${job.address || ""}</p>
            <button class="text-green-400 text-xs underline mt-1" id="modalOpenMap">
              <i class="fas fa-external-link-alt mr-1"></i>Open in Maps
            </button>
          </div>
          <div>
            <h4 class="font-semibold mb-1">${t("timeLabel")}</h4>
            <p class="text-gray-300">${when}</p>
          </div>
          <div>
            <h4 class="font-semibold mb-1">${t("priceLabel")}</h4>
            <p class="text-2xl font-bold text-green-400">${job.price ? `$${job.price}` : "$‚Äî"}</p>
          </div>
          ${
            notes
              ? `
          <div>
            <h4 class="font-semibold mb-1">${t("notesLabel")}</h4>
            <p class="text-gray-300">${notes}</p>
          </div>
          `
              : ""
          }
          <button class="neon-button w-full mt-4" id="modalAcceptBtn">
            ${t("acceptJobButton")}
          </button>
        </div>
      `;

      $("jobModal").classList.remove("hidden");

      $("modalOpenMap")?.addEventListener("click", () => openMaps(job.address));
      $("modalAcceptBtn")?.addEventListener("click", () => acceptJob(job));
    }

    async function acceptJob(job) {
      if (!currentWorker) return;
      const btn = $("modalAcceptBtn");
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

      try {
        const { error } = await supabase
          .from("orders")
          .update({ worker_id: currentWorker.id, status: "accepted" })
          .eq("id", job.id);

        if (error) throw error;

        $("jobModal").classList.add("hidden");
        await loadAllData();
        showToast(t("jobAcceptedToast"));
      } catch (e) {
        console.error("acceptJob error:", e);
        showToast(t("errorUpdatingJob"));
      } finally {
        btn.disabled = false;
        btn.textContent = t("acceptJobButton");
      }
    }

    async function updateJobStatus(job) {
      const nextStatus = job.status === "accepted" ? "in_progress" : "completed";

      try {
        const { error } = await supabase
          .from("orders")
          .update({ status: nextStatus })
          .eq("id", job.id);

        if (error) throw error;

        if (nextStatus === "completed") {
          const newCount = (currentWorker.jobs_completed || 0) + 1;
          await supabase
            .from("workers")
            .update({ jobs_completed: newCount })
            .eq("id", currentWorker.id);

          currentWorker.jobs_completed = newCount;
          updateProfileUI();
        }

        await loadAllData();
        showToast(
          nextStatus === "completed" ? t("jobCompletedToast") : t("jobStartedToast")
        );
      } catch (e) {
        console.error("updateJobStatus error:", e);
        showToast(t("errorUpdatingJob"));
      }
    }

    function openMaps(address) {
      if (!address) return;
      const url = "https://www.google.com/maps?q=" + encodeURIComponent(address);
      window.open(url, "_blank");
    }

    function callPhone(phone) {
      if (!phone) return;
      const clean = phone.replace(/[^+\d]/g, "");
      window.open("tel:" + clean, "_blank");
    }

    function showSkillsEditor() {
      if (!currentWorker) return;
      const workerSkills = currentWorker.skills || [];
      const container = $("skillsList");
      container.innerHTML = "";

      availableSkills.forEach((skill) => {
        const label = document.createElement("label");
        label.className = "flex items-center p-3 glass-card cursor-pointer";

        label.innerHTML = `
          <input type="checkbox" class="skill-checkbox mr-3" value="${skill}"
            ${workerSkills.includes(skill) ? "checked" : ""} />
          <span class="capitalize">${skill.replace("_", " ")}</span>
        `;

        container.appendChild(label);
      });

      $("skillsModal").classList.remove("hidden");
    }

    async function saveSkills() {
      if (!currentWorker) return;
      const checkboxes = $("skillsList").querySelectorAll("input.skill-checkbox:checked");
      const selected = Array.from(checkboxes).map((cb) => cb.value);

      try {
        const { error } = await supabase
          .from("workers")
          .update({ skills: selected })
          .eq("id", currentWorker.id);

        if (error) throw error;

        currentWorker.skills = selected;
        $("skillsModal").classList.add("hidden");
        await loadAllData();
        showToast(t("skillsUpdatedToast"));
      } catch (e) {
        console.error("saveSkills error:", e);
        showToast(t("errorSavingSkills"));
      }
    }

    async function saveBio() {
      if (!currentWorker) return;
      const bio = $("aboutMeInput").value.trim();
      try {
        const { error } = await supabase
          .from("workers")
          .update({ about_me: bio })
          .eq("id", currentWorker.id);

        if (error) throw error;

        currentWorker.about_me = bio;
        showToast(t("bioSavedToast"));
      } catch (e) {
        console.error("saveBio error:", e);
        showToast(t("errorSavingSkills"));
      }
    }

    async function toggleNotifications() {
      if (!currentWorker) return;
      const prev =
        currentWorker.notifications_enabled === null ||
        currentWorker.notifications_enabled === undefined
          ? true
          : currentWorker.notifications_enabled;
      const next = !prev;

      try {
        const { error } = await supabase
          .from("workers")
          .update({ notifications_enabled: next })
          .eq("id", currentWorker.id);

        if (error) throw error;

        currentWorker.notifications_enabled = next;
        const toggle = $("notificationsToggle");
        if (next) toggle.classList.add("on");
        else toggle.classList.remove("on");
        updateNotificationText();
        showToast(next ? t("notifOnToast") : t("notifOffToast"));
      } catch (e) {
        console.error("toggleNotifications error:", e);
        showToast(t("errorUpdatingJob"));
      }
    }

    async function changeLanguage(lang) {
      currentLanguage = lang;
      updateTexts();
      if (!currentWorker) return;
      try {
        await supabase
          .from("workers")
          .update({ language: lang })
          .eq("id", currentWorker.id);
        currentWorker.language = lang;
        showToast(t("languageChangedToast"));
      } catch (e) {
        console.error("changeLanguage error:", e);
      }
    }

    async function uploadAvatar(file) {
      if (!currentWorker || !file) return;
      const fileExt = file.name.split(".").pop();
      const fileName = `${currentWorker.id}-${Date.now()}.${fileExt}`;
      const filePath = `public/${fileName}`;

      try {
        const { error: uploadError } = await supabase.storage
          .from("avatars")
          .upload(filePath, file, { upsert: true });

        if (uploadError) throw uploadError;

        const { data } = supabase.storage.from("avatars").getPublicUrl(filePath);
        const publicUrl = data.publicUrl;

        const { error: updateError } = await supabase
          .from("workers")
          .update({ avatar_url: publicUrl })
          .eq("id", currentWorker.id);

        if (updateError) throw updateError;

        currentWorker.avatar_url = publicUrl;
        updateProfileUI();
        showToast(t("avatarUpdatedToast"));
      } catch (e) {
        console.error("uploadAvatar error:", e);
        showToast(t("avatarErrorToast"));
      }
    }

    function switchTab(tabName) {
      document.querySelectorAll(".tab-button").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.tab === tabName);
      });

      ["jobs", "active", "profile"].forEach((tname) => {
        const el = $(tname + "Tab");
        if (!el) return;
        el.classList.toggle("hidden", tname !== tabName);
      });
    }

    // EVENTS
    $("loginButton").addEventListener("click", () => {
      telegramLogin();
    });

    $("closeModal").addEventListener("click", () => {
      $("jobModal").classList.add("hidden");
    });

    $("closeSkillsModal").addEventListener("click", () => {
      $("skillsModal").classList.add("hidden");
    });

    $("cancelSkills").addEventListener("click", () => {
      $("skillsModal").classList.add("hidden");
    });

    $("saveSkills").addEventListener("click", saveSkills);
    $("editSkillsButton").addEventListener("click", showSkillsEditor);
    $("saveAboutButton").addEventListener("click", saveBio);
    $("notificationsToggle").addEventListener("click", toggleNotifications);

    $("avatarButton").addEventListener("click", () => {
      $("avatarFileInput").click();
    });
    $("changePhotoButton").addEventListener("click", () => {
      $("avatarFileInput").click();
    });
    $("avatarFileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) uploadAvatar(file);
    });

    document.querySelectorAll("[data-tab]").forEach((btn) => {
      btn.addEventListener("click", () => {
        switchTab(btn.dataset.tab);
      });
    });

    document.querySelectorAll(".chip-lang").forEach((btn) => {
      btn.addEventListener("click", () => {
        const lang = btn.dataset.lang;
        changeLanguage(lang);
      });
    });

    // Telegram BackButton ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫–∏
    if (tg) {
      tg.BackButton.onClick(() => {
        if (!$("jobModal").classList.contains("hidden")) {
          $("jobModal").classList.add("hidden");
        } else if (!$("skillsModal").classList.contains("hidden")) {
          $("skillsModal").classList.add("hidden");
        }
      });

      const observer = new MutationObserver(() => {
        const modalOpen = !$("jobModal").classList.contains("hidden");
        const skillsOpen = !$("skillsModal").classList.contains("hidden");
        if (modalOpen || skillsOpen) tg.BackButton.show();
        else tg.BackButton.hide();
      });

      observer.observe($("jobModal"), { attributes: true });
      observer.observe($("skillsModal"), { attributes: true });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      if (tg?.initDataUnsafe?.user?.language_code) {
        const lc = tg.initDataUnsafe.user.language_code;
        if (lc === "ru") currentLanguage = "ru";
        else if (lc === "es") currentLanguage = "es";
        else if (lc === "ky" || lc === "kg") currentLanguage = "ky";
      }
      updateTexts();

      if (tg?.initDataUnsafe?.user?.id) {
        await telegramLogin();
      }
    });
  </script>
</body>
</html>
