ggghh hjjnn
–°–µ–≥–æ–¥–Ω—è, 14:03
–ö–æ–º—É:–≤–∞–º
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ELIMAN WORKER</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <base target="_blank" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

    * {
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }

    body {
      background: radial-gradient(circle at 50% 0%, #0a0e1a 0%, #020613 100%);
      color: #ffffff;
      overflow-x: hidden;
      margin: 0;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .neon-button {
      background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
      color: #020613;
      font-weight: 700;
      border: none;
      border-radius: 16px;
      padding: 14px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(31, 227, 136, 0.3);
    }

    .neon-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(31, 227, 136, 0.5);
    }

    .neon-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .status-pill {
      background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
      color: #020613;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .job-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .job-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }

    .tab-button {
      transition: all 0.3s ease;
      border-radius: 12px;
      padding: 10px;
      color: #64748b;
    }

    .tab-button.active {
      background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
      color: #020613;
      font-weight: 600;
    }

    .modal-overlay {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
    }

    .loading-spinner {
      border: 2px solid rgba(31, 227, 136, 0.3);
      border-top: 2px solid #1FE388;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .fade-in {
      animation: fadeIn 0.4s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .price-tag {
      background: linear-gradient(135deg, #1FE388 0%, #6BFF9D 100%);
      color: #020613;
      padding: 8px 14px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 18px;
    }

    .photo-placeholder {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(31, 227, 136, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1FE388;
    }

    .bottom-nav {
      background: rgba(2, 6, 19, 0.96);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .refresh-btn {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(31, 227, 136, 0.3);
      border-radius: 12px;
      padding: 8px 12px;
      color: #1FE388;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      background: rgba(31, 227, 136, 0.1);
    }

    .refresh-icon.spinning {
      animation: spin 1s linear infinite;
    }

    .load-more-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 12px;
      text-align: center;
      color: #1FE388;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.3s ease;
    }

    .load-more-btn:hover {
      background: rgba(31, 227, 136, 0.1);
    }

    /* Profile stats */
    .stat-card {
      background: rgba(255, 255, 255, 0.04);
      border-radius: 16px;
      padding: 12px 14px;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      font-size: 12px;
      margin: 2px;
    }

    .bio-textarea {
      width: 100%;
      min-height: 120px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 14px;
      padding: 12px;
      color: #fff;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 16px;
    }

    .bio-textarea:focus {
      outline: none;
      border-color: #1FE388;
      box-shadow: 0 0 0 2px rgba(31, 227, 136, 0.3);
    }

    .skills-list {
      display: grid;
      gap: 12px;
      margin-bottom: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .skill-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .skill-item:hover {
      background: rgba(31, 227, 136, 0.1);
      border-color: rgba(31, 227, 136, 0.3);
    }

    .skill-item input {
      margin-right: 12px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .skill-item label {
      cursor: pointer;
      flex: 1;
    }

    .modal-content {
      max-width: 500px;
      width: 100%;
    }
  </style>
</head>
<body class="min-h-screen pb-20">

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="min-h-screen flex flex-col items-center justify-center p-6">
    <div class="text-center mb-8">
      <div class="w-20 h-20 rounded-2xl mx-auto mb-4 bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-3xl font-extrabold">
        E
      </div>
      <h1 class="text-3xl font-black mb-2">ELIMAN</h1>
      <h2 id="welcomeTitle" class="text-xl font-semibold mb-2">Welcome, worker</h2>
      <p id="welcomeSubtitle" class="text-gray-400 text-sm">
        Sign in via Telegram to start accepting jobs in your area
      </p>
    </div>

    <div class="w-full max-w-sm">
      <div class="glass-card p-6 mb-4 text-center">
        <p id="loginHint" class="text-gray-400 text-sm mb-4">
          This mini app works only inside Telegram. Open from bot and press "Login".
        </p>
        <button id="loginButton" class="neon-button w-full">
          <span id="loginButtonText">Login with Telegram</span>
        </button>
        <div id="loginError" class="text-red-400 text-sm mt-3 text-center hidden"></div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="mainScreen" class="hidden min-h-screen">

    <!-- HEADER -->
    <div class="sticky top-0 z-40 bg-black/60 backdrop-blur-lg border-b border-white/10">
      <div class="flex items-center justify-between p-4">
        <div>
          <div class="text-xs tracking-[0.25em] text-green-400 uppercase mb-1">Eliman</div>
          <h1 class="text-xl font-bold">Worker Console</h1>
        </div>
        <div class="flex items-center gap-2">
          <button id="onlineToggle" class="status-pill">
            <i class="fas fa-bell mr-1"></i><span id="onlineToggleText">Online</span>
          </button>
          <button id="refreshButton" class="refresh-btn">
            <i class="fas fa-sync-alt refresh-icon"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- CONTENT -->
    <div id="tabContent" class="p-4 pb-24">

      <!-- JOBS TAB -->
      <div id="jobsTab" class="tab-content">
        <div class="mb-6">
          <h2 id="newJobsTitle" class="text-2xl font-bold mb-1">New Jobs</h2>
          <p id="newJobsSubtitle" class="text-gray-400 text-sm">
            Available jobs matching your skills
          </p>
        </div>
        <div id="jobsList" class="space-y-4"></div>
        <div id="loadMoreJobs" class="load-more-btn hidden">
          <i class="fas fa-chevron-down mr-2"></i><span id="loadMoreJobsLabel">Load More</span>
        </div>
        <div id="noJobsText" class="text-center text-gray-400 py-8 hidden">
          <i class="fas fa-inbox text-4xl mb-4"></i>
          <p>No jobs available right now</p>
        </div>
      </div>

      <!-- ACTIVE TAB -->
      <div id="activeTab" class="tab-content hidden">
        <div class="mb-6">
          <h2 id="activeJobsTitle" class="text-2xl font-bold mb-1">Active Jobs</h2>
          <p id="activeJobsSubtitle" class="text-gray-400 text-sm">
            Jobs you're currently working on
          </p>
        </div>
        <div id="activeJobsList" class="space-y-4"></div>
        <div id="loadMoreActive" class="load-more-btn hidden">
          <i class="fas fa-chevron-down mr-2"></i><span id="loadMoreActiveLabel">Load More</span>
        </div>
        <div id="noActiveJobsText" class="text-center text-gray-400 py-8 hidden">
          <i class="fas fa-clock text-4xl mb-4"></i>
          <p>No active jobs</p>
        </div>
      </div>

      <!-- PROFILE TAB -->
      <div id="profileTab" class="tab-content hidden">
        <div class="mb-6">
          <h2 id="profileTitle" class="text-2xl font-bold mb-1">Profile</h2>
        </div>

        <div class="glass-card p-6 mb-4">
          <!-- AVATAR + NAME + STATUS -->
          <div class="flex flex-col items-center mb-5">
            <div
              id="profileAvatar"
              class="w-32 h-32 rounded-full bg-gradient-to-br from-green-400 to-green-700 shadow-[0_0_25px_rgba(34,197,94,0.7)] flex items-center justify-center text-3xl font-bold overflow-hidden mb-3">
              <span id="profileInitials">WW</span>
            </div>
            <h3 id="profileName" class="text-2xl font-semibold mb-1">Worker</h3>
            <p id="profileAddress" class="text-gray-400 text-sm mb-1">
              Address not set
            </p>
            <p id="profileId" class="text-gray-500 text-xs mb-3">
              ID: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
            </p>
            <span
              id="profileStatus"
              class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-emerald-500/15 text-emerald-300 border border-emerald-400/40">
              <span class="w-2 h-2 rounded-full bg-emerald-400 mr-2"></span>
              Online
            </span>
          </div>

          <!-- STATS -->
          <div class="grid grid-cols-2 gap-3 mb-5 w-full">
            <div class="stat-card">
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-gray-400">Rating</span>
                <i class="fas fa-star text-yellow-400 text-sm"></i>
              </div>
              <div class="flex items-baseline gap-1">
                <span class="text-xl font-bold">5.0</span>
                <span id="profileRatingLabel" class="text-xs text-gray-400">rating</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-gray-400">Completed</span>
                <i class="fas fa-check-circle text-emerald-400 text-sm"></i>
              </div>
              <div class="flex items-baseline gap-1">
                <span id="jobsCompleted" class="text-xl font-bold text-green-400">0</span>
                <span id="profileJobsLabel" class="text-xs text-gray-400">jobs completed</span>
              </div>
            </div>
          </div>

          <!-- BIO -->
          <div class="mb-4 w-full">
            <div class="flex justify-between items-center mb-1">
              <span class="text-sm font-semibold">About</span>
              <button id="editBioButton" class="text-xs text-green-400 underline">Edit</button>
            </div>
            <p id="profileBio" class="text-sm text-gray-300">
              Handyman with 5+ years experience. Professional and fast.
            </p>
          </div>

          <!-- SKILLS -->
          <div class="mb-3 w-full">
            <div class="flex justify-between items-center mb-1">
              <span class="text-sm font-semibold" id="skillsLabel">Skills</span>
            </div>
            <div id="profileSkills" class="flex flex-wrap">
              <!-- chips -->
            </div>
          </div>
        </div>

        <!-- ACTION BUTTONS -->
        <div class="space-y-3">
          <button id="changePhotoButton" class="neon-button w-full flex items-center justify-center gap-2">
            <i class="fas fa-camera"></i>
            <span>Change profile photo</span>
          </button>

          <button id="editProfileButton" class="w-full py-3 rounded-2xl font-semibold text-sm bg-white/5 border border-white/10 flex items-center justify-between px-4">
            <div class="flex items-center gap-2">
              <i class="fas fa-user-edit text-green-400"></i>
              <span>Edit Profile (Bio + Address)</span>
            </div>
            <i class="fas fa-chevron-right text-xs text-gray-400"></i>
          </button>

          <button id="manageSkillsButton" class="w-full py-3 rounded-2xl font-semibold text-sm bg-white/5 border border-white/10 flex items-center justify-between px-4">
            <div class="flex items-center gap-2">
              <i class="fas fa-tools text-green-400"></i>
              <span>Manage Skills</span>
            </div>
            <i class="fas fa-chevron-right text-xs text-gray-400"></i>
          </button>

          <!-- Language -->
          <button id="changeLangButton" class="w-full py-3 rounded-2xl font-semibold text-sm bg-white/5 border border-white/10 flex items-center justify-between px-4">
            <div class="flex items-center gap-2">
              <i class="fas fa-language text-green-400"></i>
              <span>Language: <span id="currentLangLabel">English</span></span>
            </div>
            <i class="fas fa-sync text-xs text-gray-400"></i>
          </button>

          <!-- Notifications -->
          <button id="notifToggle" class="w-full py-3 rounded-2xl font-semibold text-sm bg-white/5 border border-white/10 flex items-center justify-between px-4">
            <div class="flex items-center gap-2">
              <i class="fas fa-bell text-green-400"></i>
              <span>Notifications</span>
            </div>
            <span class="status-pill text-xs" id="notifToggleText">ON</span>
          </button>
        </div>
      </div>

      <!-- HISTORY TAB -->
      <div id="historyTab" class="tab-content hidden">
        <div class="mb-6">
          <h2 id="historyTitle" class="text-2xl font-bold mb-1">History</h2>
          <p id="historySubtitle" class="text-gray-400 text-sm">
            Completed jobs and your rank
          </p>
        </div>

        <div class="glass-card p-4 mb-4">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="text-sm text-gray-400">Total completed</div>
              <div id="historyTotal" class="text-2xl font-bold text-green-400">0</div>
            </div>
            <div class="text-right">
              <div class="text-sm text-gray-400">Your rank</div>
              <div id="historyRank" class="text-xl font-semibold">‚Äî</div>
            </div>
          </div>
        </div>

        <div id="historyList" class="space-y-3"></div>
        <div id="loadMoreHistory" class="load-more-btn hidden">
          <i class="fas fa-chevron-down mr-2"></i><span id="loadMoreHistoryLabel">Load More</span>
        </div>
        <div id="noHistoryText" class="text-center text-gray-400 py-8 hidden">
          <i class="fas fa-list-alt text-4xl mb-4"></i>
          <p>No completed jobs yet</p>
        </div>
      </div>

    </div>

    <!-- BOTTOM NAV -->
    <div class="fixed bottom-0 left-0 right-0 bottom-nav z-50">
      <div class="flex justify-around p-2">
        <button class="tab-button active flex flex-col items-center flex-1" data-tab="jobs">
          <i class="fas fa-briefcase text-xl mb-1"></i>
          <span id="jobsTabLabel" class="text-xs">Jobs</span>
        </button>
        <button class="tab-button flex flex-col items-center flex-1" data-tab="active">
          <i class="fas fa-clock text-xl mb-1"></i>
          <span id="activeTabLabel" class="text-xs">Active</span>
        </button>
        <button class="tab-button flex flex-col items-center flex-1" data-tab="profile">
          <i class="fas fa-user text-xl mb-1"></i>
          <span id="profileTabLabel" class="text-xs">Profile</span>
        </button>
        <button class="tab-button flex flex-col items-center flex-1" data-tab="history">
          <i class="fas fa-list-alt text-xl mb-1"></i>
          <span id="historyTabLabel" class="text-xs">History</span>
        </button>
      </div>
    </div>
  </div>

  <!-- JOB DETAILS MODAL -->
  <div id="jobModal" class="fixed inset-0 z-50 hidden modal-overlay">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="glass-card max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-start mb-4">
            <h3 id="modalTitle" class="text-xl font-bold">Job Details</h3>
            <button id="closeModal" class="text-gray-400 hover:text-white">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div id="modalContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PROFILE EDITOR MODAL -->
  <div id="profileEditorModal" class="fixed inset-0 z-50 hidden modal-overlay">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="glass-card modal-content">
        <div class="p-6">
          <div class="flex justify-between items-start mb-4">
            <h3 class="text-xl font-bold">Edit Profile</h3>
            <button id="closeProfileEditor" class="text-gray-400 hover:text-white">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2">Address</label>
              <input id="addressInput" type="text"
                     class="w-full p-3 rounded-lg bg-white/5 border border-white/10 text-white"
                     placeholder="Enter your working area">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">Bio</label>
              <textarea id="bioInput" class="bio-textarea" placeholder="Write about your experience..."></textarea>
            </div>
            <button id="saveProfileButton" class="neon-button w-full">Save Profile</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SKILLS EDITOR MODAL -->
  <div id="skillsModal" class="fixed inset-0 z-50 hidden modal-overlay">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="glass-card max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-start mb-4">
            <h3 class="text-xl font-bold">Manage Skills</h3>
            <button id="closeSkillsModal" class="text-gray-400 hover:text-white">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="skills-list" id="skillsList"></div>
          <button id="saveSkillsButton" class="neon-button w-full">Save Skills</button>
        </div>
      </div>
    </div>
  </div>

  <!-- APP LOGIC -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // üîê Supabase (—Ç–≤–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
    const SUPABASE_URL = "https://zmjvhedwxdopieuteiky.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptanZoZWR3eGRvcGlldXRlaWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MTI1MTksImV4cCI6MjA4MDI4ODUxOX0.1_YyxVTJK2MvDTKmeSjrcgXHNbCr73dEv_1fr1tkeAA";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.disableVerticalSwipes();
    }

    // üåç i18n (EN / RU / ES)
    const i18n = {
      en: {
        welcomeTitle: "Welcome, worker",
        welcomeSubtitle: "Sign in via Telegram to start accepting jobs in your area",
        loginButton: "Login with Telegram",
        loginHint: "This mini app works only inside Telegram. Open from bot.",
        loginErrorNoWorker: "Worker not found. Please contact support.",
        jobsTabLabel: "Jobs",
        activeTabLabel: "Active",
        profileTabLabel: "Profile",
        historyTabLabel: "History",
        newJobsTitle: "New Jobs",
        newJobsSubtitle: "Available jobs matching your skills",
        activeJobsTitle: "Active Jobs",
        activeJobsSubtitle: "Jobs you're currently working on",
        profileTitle: "Profile",
        profileRatingLabel: "rating",
        profileJobsLabel: "jobs completed",
        historyTitle: "History",
        historySubtitle: "Completed jobs and your rank",
        noJobsText: "No jobs available right now",
        noActiveJobsText: "No active jobs",
        noHistoryText: "No completed jobs yet",
        viewDetailsButton: "View Details ‚Üí",
        acceptJobButton: "Accept Job",
        startJobButton: "Start Job",
        completeJobButton: "Complete Job",
        addressLabel: "Address",
        timeLabel: "Time",
        clientLabel: "Client",
        priceLabel: "Price",
        notesLabel: "Notes",
        skillsLabel: "Skills",
        errorLoadingJobs: "Error loading jobs",
        errorUpdatingJob: "Error updating job",
        jobAcceptedToast: "Job accepted!",
        jobStartedToast: "Job started!",
        jobCompletedToast: "Job completed!",
        skillsUpdatedToast: "Skills updated!",
        profileUpdatedToast: "Profile updated!",
        newJobToast: "New job available",
        newJobPopup: "New job is available. Open Jobs tab to see details.",
        onlineText: "Online",
        offlineText: "Offline",
        notifOn: "ON",
        notifOff: "OFF",
        langEnglish: "English",
        langRussian: "Russian",
        langSpanish: "Spanish",
        loadMoreButton: "Load More",
        initError: "Please open this app from Telegram bot",
      },
      ru: {
        welcomeTitle: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, —Ä–∞–±–æ—Ç–Ω–∏–∫",
        welcomeSubtitle: "–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–∫–∞–∑—ã —Ä—è–¥–æ–º —Å –≤–∞–º–∏",
        loginButton: "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram",
        loginHint: "–≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.",
        loginErrorNoWorker: "–†–∞–±–æ—Ç–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.",
        jobsTabLabel: "–ó–∞–∫–∞–∑—ã",
        activeTabLabel: "–ê–∫—Ç–∏–≤–Ω—ã–µ",
        profileTabLabel: "–ü—Ä–æ—Ñ–∏–ª—å",
        historyTabLabel: "–ò—Å—Ç–æ—Ä–∏—è",
        newJobsTitle: "–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã",
        newJobsSubtitle: "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã –ø–æ –≤–∞—à–∏–º –Ω–∞–≤—ã–∫–∞–º",
        activeJobsTitle: "–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã",
        activeJobsSubtitle: "–ó–∞–∫–∞–∑—ã, –Ω–∞–¥ –∫–æ—Ç–æ—Ä—ã–º–∏ –≤—ã —Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç–µ",
        profileTitle: "–ü—Ä–æ—Ñ–∏–ª—å",
        profileRatingLabel: "—Ä–µ–π—Ç–∏–Ω–≥",
        profileJobsLabel: "–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤",
        historyTitle: "–ò—Å—Ç–æ—Ä–∏—è",
        historySubtitle: "–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã –∏ –≤–∞—à —Ä–µ–π—Ç–∏–Ω–≥",
        noJobsText: "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤",
        noActiveJobsText: "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤",
        noHistoryText: "–ù–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤",
        viewDetailsButton: "–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí",
        acceptJobButton: "–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑",
        startJobButton: "–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É",
        completeJobButton: "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É",
        addressLabel: "–ê–¥—Ä–µ—Å",
        timeLabel: "–í—Ä–µ–º—è",
        clientLabel: "–ö–ª–∏–µ–Ω—Ç",
        priceLabel: "–¶–µ–Ω–∞",
        notesLabel: "–ó–∞–º–µ—Ç–∫–∏",
        skillsLabel: "–ù–∞–≤—ã–∫–∏",
        errorLoadingJobs: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤",
        errorUpdatingJob: "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞",
        jobAcceptedToast: "–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!",
        jobStartedToast: "–†–∞–±–æ—Ç–∞ –Ω–∞—á–∞—Ç–∞!",
        jobCompletedToast: "–†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!",
        skillsUpdatedToast: "–ù–∞–≤—ã–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!",
        profileUpdatedToast: "–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω!",
        newJobToast: "–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –¥–æ—Å—Ç—É–ø–µ–Ω",
        newJobPopup: "–ü–æ—è–≤–∏–ª—Å—è –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É ¬´–ó–∞–∫–∞–∑—ã¬ª.",
        onlineText: "–û–Ω–ª–∞–π–Ω",
        offlineText: "–û—Ñ–ª–∞–π–Ω",
        notifOn: "–í–ö–õ",
        notifOff: "–í–´–ö–õ",
        langEnglish: "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π",
        langRussian: "–†—É—Å—Å–∫–∏–π",
        langSpanish: "–ò—Å–ø–∞–Ω—Å–∫–∏–π",
        loadMoreButton: "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë",
        initError: "–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ Telegram-–±–æ—Ç–∞",
      },
      es: {
        welcomeTitle: "Bienvenido, trabajador",
        welcomeSubtitle: "Inicia sesi√≥n con Telegram para aceptar trabajos en tu √°rea",
        loginButton: "Entrar con Telegram",
        loginHint: "Esta mini app solo funciona dentro de Telegram. √Åbrela desde el bot.",
        loginErrorNoWorker: "Trabajador no encontrado. Contacta soporte.",
        jobsTabLabel: "Trabajos",
        activeTabLabel: "Activos",
        profileTabLabel: "Perfil",
        historyTabLabel: "Historial",
        newJobsTitle: "Nuevos trabajos",
        newJobsSubtitle: "Trabajos disponibles seg√∫n tus habilidades",
        activeJobsTitle: "Trabajos activos",
        activeJobsSubtitle: "Trabajos que est√°s realizando",
        profileTitle: "Perfil",
        profileRatingLabel: "calificaci√≥n",
        profileJobsLabel: "trabajos completados",
        historyTitle: "Historial",
        historySubtitle: "Trabajos completados y tu ranking",
        noJobsText: "No hay trabajos disponibles",
        noActiveJobsText: "No hay trabajos activos",
        noHistoryText: "A√∫n no hay trabajos completados",
        viewDetailsButton: "Ver detalles ‚Üí",
        acceptJobButton: "Aceptar trabajo",
        startJobButton: "Iniciar trabajo",
        completeJobButton: "Completar trabajo",
        addressLabel: "Direcci√≥n",
        timeLabel: "Hora",
        clientLabel: "Cliente",
        priceLabel: "Precio",
        notesLabel: "Notas",
        skillsLabel: "Habilidades",
        errorLoadingJobs: "Error al cargar trabajos",
        errorUpdatingJob: "Error al actualizar trabajo",
        jobAcceptedToast: "¬°Trabajo aceptado!",
        jobStartedToast: "¬°Trabajo iniciado!",
        jobCompletedToast: "¬°Trabajo completado!",
        skillsUpdatedToast: "¬°Habilidades actualizadas!",
        profileUpdatedToast: "¬°Perfil actualizado!",
        newJobToast: "Nuevo trabajo disponible",
        newJobPopup: "Hay un nuevo trabajo disponible. Abre la pesta√±a Trabajos.",
        onlineText: "En l√≠nea",
        offlineText: "Desconectado",
        notifOn: "ON",
        notifOff: "OFF",
        langEnglish: "Ingl√©s",
        langRussian: "Ruso",
        langSpanish: "Espa√±ol",
        loadMoreButton: "Cargar m√°s",
        initError: "Abra esta app desde el bot de Telegram",
      },
    };

    let currentLanguage = "en";
    let currentWorker = null;
    let jobs = [];
    let activeJobs = [];
    let historyJobs = [];
    let isOnline = true;
    let notificationsEnabled = true;
    let ordersChannel = null;

    const JOBS_PER_PAGE = 10;
    let jobsPage = 0;
    let activePage = 0;
    let historyPage = 0;
    let currentTab = "jobs";

    const availableSkills = [
      "cleaning",
      "handyman",
      "moving",
      "locksmith",
      "appliance_repair",
      "furniture_assembly",
      "lawn_care",
      "gutter_cleaning",
    ];

    const $ = (id) => document.getElementById(id);
    const t = (key) => i18n[currentLanguage][key] || key;

    function updateTexts() {
      $("welcomeTitle").textContent = t("welcomeTitle");
      $("welcomeSubtitle").textContent = t("welcomeSubtitle");
      $("loginButtonText").textContent = t("loginButton");
      $("loginHint").textContent = t("loginHint");

      $("newJobsTitle").textContent = t("newJobsTitle");
      $("newJobsSubtitle").textContent = t("newJobsSubtitle");
      $("activeJobsTitle").textContent = t("activeJobsTitle");
      $("activeJobsSubtitle").textContent = t("activeJobsSubtitle");
      $("profileTitle").textContent = t("profileTitle");
      $("profileRatingLabel").textContent = t("profileRatingLabel");
      $("profileJobsLabel").textContent = t("profileJobsLabel");
      $("historyTitle").textContent = t("historyTitle");
      $("historySubtitle").textContent = t("historySubtitle");

      $("jobsTabLabel").textContent = t("jobsTabLabel");
      $("activeTabLabel").textContent = t("activeTabLabel");
      $("profileTabLabel").textContent = t("profileTabLabel");
      $("historyTabLabel").textContent = t("historyTabLabel");

      $("skillsLabel").textContent = t("skillsLabel");

      $("noJobsText").querySelector("p").textContent = t("noJobsText");
      $("noActiveJobsText").querySelector("p").textContent = t("noActiveJobsText");
      $("noHistoryText").querySelector("p").textContent = t("noHistoryText");

      $("loadMoreJobsLabel").textContent = t("loadMoreButton");
      $("loadMoreActiveLabel").textContent = t("loadMoreButton");
      $("loadMoreHistoryLabel").textContent = t("loadMoreButton");

      $("onlineToggleText").textContent = isOnline ? t("onlineText") : t("offlineText");
      $("profileStatus").innerHTML =
        `<span class="w-2 h-2 rounded-full mr-2 ${isOnline ? "bg-emerald-400" : "bg-gray-400"}"></span>` +
        (isOnline ? t("onlineText") : t("offlineText"));

      $("notifToggleText").textContent = notificationsEnabled ? t("notifOn") : t("notifOff");

      const langLabel =
        currentLanguage === "en"
          ? t("langEnglish")
          : currentLanguage === "ru"
          ? t("langRussian")
          : t("langSpanish");
      $("currentLangLabel").textContent = langLabel;
    }

    function showToast(message) {
      const toast = document.createElement("div");
      toast.className =
        "fixed top-4 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg z-[9999] shadow-lg text-sm";
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    function showLoginError(msg) {
      const el = $("loginError");
      el.textContent = msg;
      el.classList.remove("hidden");
    }

    function showMainScreen() {
      $("loginScreen").classList.add("hidden");
      $("mainScreen").classList.remove("hidden");
      updateProfileUI();
      updateTexts();
    }

    function updateProfileUI() {
      if (!currentWorker) return;
      const name = currentWorker.full_name || "Worker";
      const initials = name
        .split(" ")
        .filter(Boolean)
        .map((n) => n[0])
        .join("")
        .slice(0, 2)
        .toUpperCase();

      const avatar = $("profileAvatar");
      avatar.innerHTML = "";
      if (currentWorker.avatar_url) {
        const img = document.createElement("img");
        img.src = currentWorker.avatar_url;
        img.alt = name;
        img.className = "w-full h-full object-cover rounded-full";
        avatar.appendChild(img);
      } else {
        const span = document.createElement("span");
        span.id = "profileInitials";
        span.textContent = initials || "W";
        avatar.appendChild(span);
      }

      $("profileName").textContent = name;
      const idStr = String(currentWorker.id || "");
      $("profileId").textContent = "ID: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢" + idStr.slice(-4);
      $("jobsCompleted").textContent = currentWorker.jobs_completed || 0;
      $("profileAddress").textContent =
        currentWorker.address && currentWorker.address.trim().length
          ? currentWorker.address
          : "Address not set";
      $("profileBio").textContent =
        currentWorker.bio && currentWorker.bio.trim().length
          ? currentWorker.bio
          : "Professional worker with great experience.";

      const skills = currentWorker.skills || [];
      const skillsContainer = $("profileSkills");
      skillsContainer.innerHTML = "";
      if (!skills.length) {
        const span = document.createElement("span");
        span.className = "text-xs text-gray-400";
        span.textContent = "No skills selected";
        skillsContainer.appendChild(span);
      } else {
        skills.forEach((s) => {
          const chip = document.createElement("span");
          chip.className = "chip capitalize";
          chip.textContent = s.replace("_", " ");
          skillsContainer.appendChild(chip);
        });
      }
    }

    async function telegramLogin() {
      if (!tg || !tg.initDataUnsafe?.user) {
        showLoginError(t("initError"));
        return;
      }

      const u = tg.initDataUnsafe.user;
      const telegram_id = String(u.id);
      const lang_code = u.language_code || "en";

      if (lang_code === "ru") currentLanguage = "ru";
      else if (lang_code === "es") currentLanguage = "es";
      else currentLanguage = "en";

      updateTexts();

      const btn = $("loginButton");
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

      try {
        let { data: worker, error } = await supabase
          .from("workers")
          .select("*")
          .eq("telegram_id", telegram_id)
          .single();

        if (error || !worker) {
          showLoginError(t("loginErrorNoWorker"));
          return;
        }

        currentWorker = worker;

        if (!currentWorker.language || currentWorker.language !== currentLanguage) {
          await supabase
            .from("workers")
            .update({ language: currentLanguage })
            .eq("id", currentWorker.id);
        }

        showMainScreen();
        await loadAllData();
        setupRealtime();
      } catch (e) {
        console.error("Login error:", e);
        showLoginError("Login failed. Try again.");
      } finally {
        btn.disabled = false;
        $("loginButtonText").textContent = t("loginButton");
      }
    }

    async function loadAllData() {
      await Promise.all([
        loadJobs(true),
        loadActiveJobs(true),
        loadHistory(true),
        loadRank(),
      ]);
    }

    function showLoadingSpinner() {
      const icon = $("refreshButton").querySelector(".refresh-icon");
      icon?.classList.add("spinning");
    }

    function hideLoadingSpinner() {
      const icon = $("refreshButton").querySelector(".refresh-icon");
      icon?.classList.remove("spinning");
    }

    async function refreshCurrentTab() {
      showLoadingSpinner();
      try {
        if (currentTab === "jobs") await loadJobs(true);
        else if (currentTab === "active") await loadActiveJobs(true);
        else if (currentTab === "history") await loadHistory(true);
      } finally {
        hideLoadingSpinner();
      }
    }

    async function loadJobs(reset = false) {
      if (!currentWorker) return;
      if (reset) {
        jobsPage = 0;
        jobs = [];
      }

      const from = jobsPage * JOBS_PER_PAGE;
      const to = from + JOBS_PER_PAGE - 1;

      try {
        const { data: orders, error } = await supabase
          .from("orders")
          .select("*")
          .is("worker_id", null)
          .eq("status", "pending")
          .order("created_at", { ascending: false })
          .range(from, to);

        if (error) throw error;

        const workerSkills = currentWorker.skills || [];
        const filteredJobs = (orders || []).filter(
          (o) => workerSkills.length === 0 || workerSkills.includes(o.service_type)
        );

        jobs = reset ? filteredJobs : [...jobs, ...filteredJobs];
        renderJobs();

        $("loadMoreJobs").classList.toggle(
          "hidden",
          !orders || orders.length < JOBS_PER_PAGE
        );
      } catch (e) {
        console.error("loadJobs error:", e);
        showToast(t("errorLoadingJobs"));
      }
    }

    async function loadActiveJobs(reset = false) {
      if (!currentWorker) return;
      if (reset) {
        activePage = 0;
        activeJobs = [];
      }

      const from = activePage * JOBS_PER_PAGE;
      const to = from + JOBS_PER_PAGE - 1;

      try {
        const { data: orders, error } = await supabase
          .from("orders")
          .select("*")
          .eq("worker_id", currentWorker.id)
          .in("status", ["accepted", "in_progress"])
          .order("created_at", { ascending: false })
          .range(from, to);

        if (error) throw error;

        activeJobs = reset ? orders || [] : [...activeJobs, ...(orders || [])];
        renderActiveJobs();

        $("loadMoreActive").classList.toggle(
          "hidden",
          !orders || orders.length < JOBS_PER_PAGE
        );
      } catch (e) {
        console.error("loadActiveJobs error:", e);
        showToast(t("errorLoadingJobs"));
      }
    }

    async function loadHistory(reset = false) {
      if (!currentWorker) return;
      if (reset) {
        historyPage = 0;
        historyJobs = [];
      }

      const from = historyPage * JOBS_PER_PAGE;
      const to = from + JOBS_PER_PAGE - 1;

      try {
        const { data: orders, error } = await supabase
          .from("orders")
          .select("*")
          .eq("worker_id", currentWorker.id)
          .eq("status", "completed")
          .order("created_at", { ascending: false })
          .range(from, to);

        if (error) throw error;

        historyJobs = reset ? orders || [] : [...historyJobs, ...(orders || [])];
        renderHistory();

        $("loadMoreHistory").classList.toggle(
          "hidden",
          !orders || orders.length < JOBS_PER_PAGE
        );
        $("historyTotal").textContent = historyJobs.length;
      } catch (e) {
        console.error("loadHistory error:", e);
      }
    }

    async function loadRank() {
      if (!currentWorker) return;
      try {
        const { data: workers, error } = await supabase
          .from("workers")
          .select("id, jobs_completed")
          .order("jobs_completed", { ascending: false });

        if (error) throw error;
        if (!workers) return;

        const index = workers.findIndex((w) => w.id === currentWorker.id);
        $("historyRank").textContent =
          index === -1 ? "‚Äî" : `#${index + 1} / ${workers.length}`;
      } catch (e) {
        console.error("loadRank error:", e);
      }
    }

    function renderJobs() {
      const list = $("jobsList");
      const empty = $("noJobsText");

      if (!jobs.length) {
        list.innerHTML = "";
        empty.classList.remove("hidden");
        return;
      }

      empty.classList.add("hidden");
      list.innerHTML = "";

      jobs.forEach((job) => {
        const card = document.createElement("div");
        card.className = "job-card glass-card p-4 fade-in";
        const serviceName = job.service_name || job.service_type;
        const notes = job.notes || "No additional notes";
        const shortAddress = (job.address || "").split(",")[0] || job.address || "";
        const when = [job.date, job.time].filter(Boolean).join(" ");

        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
              <h3 class="font-semibold text-lg mb-1">${serviceName}</h3>
              <p class="text-gray-400 text-sm">${notes}</p>
            </div>
            <div class="price-tag ml-3">${job.price ? `$${job.price}` : "$‚Äî"}</div>
          </div>
          <div class="flex items-center gap-4 mb-3">
            <div class="flex items-center text-sm text-gray-300">
              <i class="fas fa-map-marker-alt mr-2"></i>
              <span class="truncate">${shortAddress}</span>
            </div>
            <div class="flex items-center text-sm text-gray-300">
              <i class="fas fa-clock mr-2"></i>
              <span>${when}</span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex -space-x-2">
              <div class="photo-placeholder"><i class="fas fa-camera text-xs"></i></div>
              <div class="photo-placeholder"><i class="fas fa-camera text-xs"></i></div>
              <div class="photo-placeholder"><i class="fas fa-camera text-xs"></i></div>
              <span class="text-xs text-gray-400 ml-2 self-center">3 photos</span>
            </div>
            <button class="text-green-400 font-semibold text-sm view-details-btn">
              ${t("viewDetailsButton")}
            </button>
          </div>
        `;

        card.querySelector(".view-details-btn").addEventListener("click", () =>
          showJobDetails(job)
        );

        list.appendChild(card);
      });
    }

    function renderActiveJobs() {
      const list = $("activeJobsList");
      const empty = $("noActiveJobsText");

      if (!activeJobs.length) {
        list.innerHTML = "";
        empty.classList.remove("hidden");
        return;
      }

      empty.classList.add("hidden");
      list.innerHTML = "";

      activeJobs.forEach((job) => {
        const card = document.createElement("div");
        card.className = "glass-card p-4 fade-in";
        const serviceName = job.service_name || job.service_type;
        const shortAddress = (job.address || "").split(",")[0] || job.address || "";
        const when = [job.date, job.time].filter(Boolean).join(" ");
        const buttonLabel =
          job.status === "accepted" ? t("startJobButton") : t("completeJobButton");

        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <h3 class="font-semibold text-lg">${serviceName}</h3>
            <div class="price-tag">${job.price ? `$${job.price}` : "$‚Äî"}</div>
          </div>
          <div class="space-y-3 mb-4">
            <div class="flex items-center justify-between text-sm">
              <div class="flex items-center text-gray-200">
                <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>
                <span>${shortAddress}</span>
              </div>
              <button class="text-green-400 text-xs underline open-map-btn">
                <i class="fas fa-external-link-alt mr-1"></i>Map
              </button>
            </div>
            <div class="flex items-center justify-between text-sm">
              <div class="flex items-center text-gray-200">
                <i class="fas fa-user mr-2 text-gray-400"></i>
                <span>${job.client_name || ""}</span>
              </div>
              <button class="text-green-400 text-xs underline call-btn">
                <i class="fas fa-phone mr-1"></i>Call
              </button>
            </div>
            <div class="flex items-center text-sm text-gray-200">
              <i class="fas fa-clock mr-2 text-gray-400"></i>
              <span>${when}</span>
            </div>
          </div>
          <button class="neon-button w-full status-btn">
            ${buttonLabel}
          </button>
        `;

        card.querySelector(".open-map-btn").addEventListener("click", () =>
          openMaps(job.address)
        );
        card.querySelector(".call-btn").addEventListener("click", () =>
          callPhone(job.client_phone)
        );
        card.querySelector(".status-btn").addEventListener("click", () =>
          updateJobStatus(job)
        );

        list.appendChild(card);
      });
    }

    function renderHistory() {
      const list = $("historyList");
      const empty = $("noHistoryText");

      if (!historyJobs.length) {
        list.innerHTML = "";
        empty.classList.remove("hidden");
        $("historyTotal").textContent = "0";
        return;
      }

      empty.classList.add("hidden");
      list.innerHTML = "";

      historyJobs.forEach((job) => {
        const item = document.createElement("div");
        item.className = "glass-card p-3 text-sm";

        const serviceName = job.service_name || job.service_type;
        const when = [job.date, job.time].filter(Boolean).join(" ");
        const shortAddress = (job.address || "").split(",")[0] || job.address || "";

        item.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-semibold">${serviceName}</span>
            <span class="text-green-400 font-bold">${
              job.price ? `$${job.price}` : "$‚Äî"
            }</span>
          </div>
          <div class="flex justify-between text-xs text-gray-400">
            <span><i class="fas fa-map-marker-alt mr-1"></i>${shortAddress}</span>
            <span><i class="fas fa-clock mr-1"></i>${when}</span>
          </div>
        `;
        list.appendChild(item);
      });

      $("historyTotal").textContent = historyJobs.length;
    }

    function showJobDetails(job) {
      $("modalTitle").textContent = job.service_name || job.service_type;
      const when = [job.date, job.time].filter(Boolean).join(" ");
      const notes = job.notes || "";

      $("modalContent").innerHTML = `
        <div class="space-y-4 text-sm">
          <div>
            <h4 class="font-semibold mb-1">${t("clientLabel")}</h4>
            <p class="text-gray-300">${job.client_name || ""}</p>
            <p class="text-gray-400">${job.client_phone || ""}</p>
          </div>
          <div>
            <h4 class="font-semibold mb-1">${t("addressLabel")}</h4>
            <p class="text-gray-300">${job.address || ""}</p>
            <button class="text-green-400 text-xs underline mt-1" id="modalOpenMap">
              <i class="fas fa-external-link-alt mr-1"></i>Open in Maps
            </button>
          </div>
          <div>
            <h4 class="font-semibold mb-1">${t("timeLabel")}</h4>
            <p class="text-gray-300">${when}</p>
          </div>
          <div>
            <h4 class="font-semibold mb-1">${t("priceLabel")}</h4>
            <p class="text-2xl font-bold text-green-400">${
              job.price ? `$${job.price}` : "$‚Äî"
            }</p>
          </div>
          ${
            notes
              ? `
          <div>
            <h4 class="font-semibold mb-1">${t("notesLabel")}</h4>
            <p class="text-gray-300">${notes}</p>
          </div>
          `
              : ""
          }
          <button class="neon-button w-full mt-4" id="modalAcceptBtn">
            ${t("acceptJobButton")}
          </button>
        </div>
      `;

      $("jobModal").classList.remove("hidden");

      $("modalOpenMap")?.addEventListener("click", () => openMaps(job.address));
      $("modalAcceptBtn")?.addEventListener("click", () => acceptJob(job));
    }

    async function acceptJob(job) {
      if (!currentWorker) return;
      const btn = $("modalAcceptBtn");
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

      try {
        const { error } = await supabase
          .from("orders")
          .update({ worker_id: currentWorker.id, status: "accepted" })
          .eq("id", job.id);

        if (error) throw error;

        $("jobModal").classList.add("hidden");
        await loadAllData();
        showToast(t("jobAcceptedToast"));
      } catch (e) {
        console.error("acceptJob error:", e);
        showToast(t("errorUpdatingJob"));
      } finally {
        btn.disabled = false;
        btn.textContent = t("acceptJobButton");
      }
    }

    async function updateJobStatus(job) {
      const nextStatus = job.status === "accepted" ? "in_progress" : "completed";

      try {
        const { error } = await supabase
          .from("orders")
          .update({ status: nextStatus })
          .eq("id", job.id);

        if (error) throw error;

        if (nextStatus === "completed") {
          const newCount = (currentWorker.jobs_completed || 0) + 1;
          await supabase
            .from("workers")
            .update({ jobs_completed: newCount })
            .eq("id", currentWorker.id);

          currentWorker.jobs_completed = newCount;
          updateProfileUI();
        }

        await loadAllData();
        showToast(
          nextStatus === "completed"
            ? t("jobCompletedToast")
            : t("jobStartedToast")
        );
      } catch (e) {
        console.error("updateJobStatus error:", e);
        showToast(t("errorUpdatingJob"));
      }
    }

    function openMaps(address) {
      if (!address) return;
      const url = "https://www.google.com/maps?q=" + encodeURIComponent(address);
      window.open(url, "_blank");
    }

    function callPhone(phone) {
      if (!phone) return;
      const clean = phone.replace(/[^+\d]/g, "");
      window.open("tel:" + clean, "_blank");
    }

    // Upload profile photo
    async function uploadProfilePhoto(file) {
      if (!currentWorker || !file) return;
      try {
        const fileExt = file.name.split(".").pop();
        const filePath = `${currentWorker.id}/${Date.now()}.${fileExt || "jpg"}`;

        const { error: uploadError } = await supabase.storage
          .from("avatars")
          .upload(filePath, file, {
            cacheControl: "3600",
            upsert: true,
          });

        if (uploadError) throw uploadError;

        const { data } = supabase.storage.from("avatars").getPublicUrl(filePath);
        const publicUrl = data.publicUrl;

        const { error: updateError } = await supabase
          .from("workers")
          .update({ avatar_url: publicUrl })
          .eq("id", currentWorker.id);

        if (updateError) throw updateError;

        currentWorker.avatar_url = publicUrl;
        updateProfileUI();
        showToast("Photo updated");
      } catch (e) {
        console.error("uploadProfilePhoto error:", e);
        showToast("Error uploading photo");
      }
    }

    function changePhoto() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = async (e) => {
        const file = e.target.files?.[0];
        if (file) await uploadProfilePhoto(file);
      };
      input.click();
    }

    // Profile Editor
    function openProfileEditor() {
      $("addressInput").value = currentWorker?.address || "";
      $("bioInput").value = currentWorker?.bio || "";
      $("profileEditorModal").classList.remove("hidden");
    }

    async function saveProfile() {
      if (!currentWorker) return;
      const address = $("addressInput").value.trim();
      const bio = $("bioInput").value.trim();

      try {
        const { error } = await supabase
          .from("workers")
          .update({ address, bio })
          .eq("id", currentWorker.id);

        if (error) throw error;

        currentWorker.address = address;
        currentWorker.bio = bio;
        updateProfileUI();
        $("profileEditorModal").classList.add("hidden");
        showToast(t("profileUpdatedToast"));
      } catch (e) {
        console.error("saveProfile error:", e);
        showToast("Error updating profile");
      }
    }

    // Skills Editor
    function showSkillsEditor() {
      if (!currentWorker) return;
      const skillsList = $("skillsList");
      skillsList.innerHTML = "";
      const workerSkills = currentWorker.skills || [];

      availableSkills.forEach((skill) => {
        const item = document.createElement("div");
        item.className = "skill-item";
        item.innerHTML = `
          <input type="checkbox" id="skill-${skill}" value="${skill}" ${
          workerSkills.includes(skill) ? "checked" : ""
        }>
          <label for="skill-${skill}" class="capitalize flex-1">
            ${skill.replace("_", " ")}
          </label>
        `;
        skillsList.appendChild(item);
      });

      $("skillsModal").classList.remove("hidden");
    }

    async function saveSkills() {
      if (!currentWorker) return;
      const checkboxes = document.querySelectorAll(
        '#skillsList input[type="checkbox"]:checked'
      );
      const selectedSkills = Array.from(checkboxes).map((cb) => cb.value);

      try {
        const { error } = await supabase
          .from("workers")
          .update({ skills: selectedSkills })
          .eq("id", currentWorker.id);

        if (error) throw error;

        currentWorker.skills = selectedSkills;
        updateProfileUI();
        $("skillsModal").classList.add("hidden");
        showToast(t("skillsUpdatedToast"));
        await loadJobs(true);
      } catch (e) {
        console.error("saveSkills error:", e);
        showToast("Error saving skills");
      }
    }

    function switchTab(tabName) {
      currentTab = tabName;
      document.querySelectorAll(".tab-button").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.tab === tabName);
      });

      ["jobs", "active", "profile", "history"].forEach((name) => {
        const el = $(name + "Tab");
        if (!el) return;
        el.classList.toggle("hidden", name !== tabName);
      });
    }

    function setupRealtime() {
      if (!supabase || !currentWorker) return;

      if (ordersChannel) {
        ordersChannel.unsubscribe();
        ordersChannel = null;
      }

      if (!isOnline) return;

      ordersChannel = supabase
        .channel("orders_listener")
        .on(
          "postgres_changes",
          { event: "INSERT", schema: "public", table: "orders" },
          async (payload) => {
            const job = payload.new;
            const workerSkills = currentWorker.skills || [];
            if (workerSkills.length && !workerSkills.includes(job.service_type)) {
              return;
            }

            if (notificationsEnabled) {
              showToast(t("newJobToast"));
              if (tg?.showPopup) {
                tg.showPopup({ message: t("newJobPopup") });
              }
            }
            await loadJobs(true);
          }
        )
        .subscribe();
    }

    function toggleOnline() {
      isOnline = !isOnline;
      updateTexts();
      setupRealtime();
    }

    function toggleNotifications() {
      notificationsEnabled = !notificationsEnabled;
      updateTexts();
    }

    function changeLanguage() {
      currentLanguage =
        currentLanguage === "en" ? "ru" : currentLanguage === "ru" ? "es" : "en";
      updateTexts();
      if (currentWorker) {
        supabase
          .from("workers")
          .update({ language: currentLanguage })
          .eq("id", currentWorker.id);
      }
    }

    // EVENT LISTENERS
    $("loginButton").addEventListener("click", telegramLogin);
    $("closeModal").addEventListener("click", () =>
      $("jobModal").classList.add("hidden")
    );
    $("closeProfileEditor").addEventListener("click", () =>
      $("profileEditorModal").classList.add("hidden")
    );
    $("closeSkillsModal").addEventListener("click", () =>
      $("skillsModal").classList.add("hidden")
    );

    $("editProfileButton").addEventListener("click", openProfileEditor);
    $("saveProfileButton").addEventListener("click", saveProfile);

    $("manageSkillsButton").addEventListener("click", showSkillsEditor);
    $("saveSkillsButton").addEventListener("click", saveSkills);

    $("changePhotoButton").addEventListener("click", changePhoto);

    $("changeLangButton").addEventListener("click", changeLanguage);

    $("onlineToggle").addEventListener("click", toggleOnline);
    $("notifToggle").addEventListener("click", toggleNotifications);

    $("refreshButton").addEventListener("click", refreshCurrentTab);

    $("loadMoreJobs").addEventListener("click", async () => {
      jobsPage++;
      await loadJobs();
    });
    $("loadMoreActive").addEventListener("click", async () => {
      activePage++;
      await loadActiveJobs();
    });
    $("loadMoreHistory").addEventListener("click", async () => {
      historyPage++;
      await loadHistory();
    });

    document
      .querySelectorAll("[data-tab]")
      .forEach((btn) =>
        btn.addEventListener("click", () => switchTab(btn.dataset.tab))
      );

    // Telegram BackButton
    if (tg) {
      tg.BackButton.onClick(() => {
        if (!$("jobModal").classList.contains("hidden")) {
          $("jobModal").classList.add("hidden");
        } else if (
          !$("profileEditorModal").classList.contains("hidden")
        ) {
          $("profileEditorModal").classList.add("hidden");
        } else if (!$("skillsModal").classList.contains("hidden")) {
          $("skillsModal").classList.add("hidden");
        }
      });

      const observer = new MutationObserver(() => {
        const modalOpen =
          !$("jobModal").classList.contains("hidden") ||
          !$("profileEditorModal").classList.contains("hidden") ||
          !$("skillsModal").classList.contains("hidden");
        if (modalOpen) tg.BackButton.show();
        else tg.BackButton.hide();
      });
      observer.observe($("jobModal"), { attributes: true });
      observer.observe($("profileEditorModal"), { attributes: true });
      observer.observe($("skillsModal"), { attributes: true });
    }

    // INIT
    document.addEventListener("DOMContentLoaded", async () => {
      if (tg?.initDataUnsafe?.user?.language_code) {
        const lc = tg.initDataUnsafe.user.language_code;
        if (lc === "ru") currentLanguage = "ru";
        else if (lc === "es") currentLanguage = "es";
        else currentLanguage = "en";
      }
      updateTexts();

      if (tg?.initDataUnsafe?.user?.id) {
        await telegramLogin();
      }
    });
  </script>
</body>
</html>
